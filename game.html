<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blind Test ¬∑ Jeu</title>
  <style>
    /* === STYLES COMPLETS === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    body {
      background: #0a0c0e;
      color: #f0f4fa;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1.5rem;
    }
    #app {
      max-width: 700px;
      width: 100%;
      background: #151e26;
      border-radius: 2.5rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
      padding: 2rem 1.8rem;
    }
    h1 {
      font-size: 2.2rem;
      color: #ffffff;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    button {
      background: #2a3b4c;
      border: none;
      border-radius: 60px;
      padding: 0.85rem 1.4rem;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem 0;
      transition: all 0.2s;
      border: 1px solid #3e5a77;
    }
    button:hover:not(:disabled) {
      background: #3e5a77;
      transform: translateY(-2px);
    }
    button.primary {
      background: #3b6eff;
      border-color: #6e9eff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .hidden { display: none !important; }

    /* Vue H√¥te */
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .play-btn {
      background: linear-gradient(135deg, #5e9eff 0%, #2a5bbf 100%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      font-size: 2rem;
      border: none;
      color: white;
      cursor: pointer;
    }
    .reveal-btn {
      background: linear-gradient(135deg, #2e3b4e, #1e2835);
      border: 2px solid #3e4c5a;
      padding: 0.9rem 2rem;
      border-radius: 60px;
    }
    .timer-big {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ffaa33;
      text-align: center;
      font-family: monospace;
      background: #0f1a24;
      padding: 0.5rem;
      border-radius: 1rem;
      margin: 1rem 0;
    }
    .notification {
      background: #1e3f5a;
      border-radius: 60px;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      text-align: center;
    }
    .scoreboard {
      background: #0f1419;
      border-radius: 1.5rem;
      padding: 1rem;
      margin: 1rem 0;
    }

    /* Vue Joueur */
    .buzzer-btn {
      background: radial-gradient(circle at 30% 30%, #ff4d4d, #b30000);
      width: 200px;
      height: 200px;
      border-radius: 50%;
      margin: 2rem auto;
      font-size: 2rem;
      font-weight: bold;
      color: white;
      border: none;
      cursor: pointer;
      display: block;
    }
    .buzzer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .cooldown-timer {
      font-size: 1.2rem;
      color: #ffaa33;
      text-align: center;
    }

    /* Popups */
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e2a36;
      border: 3px solid #ffaa33;
      border-radius: 2rem;
      padding: 2rem;
      width: 90%;
      max-width: 400px;
      z-index: 1000;
      box-shadow: 0 10px 30px black;
      text-align: center;
    }
    .popup h3 {
      margin-bottom: 1rem;
      color: #ffaa33;
    }
    .popup-cover {
      width: 120px;
      height: 120px;
      border-radius: 1rem;
      margin: 1rem auto;
      object-fit: cover;
      display: block;
    }
    .popup-cover.blur {
      filter: blur(8px);
    }
    .choice-grid {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .choice-btn {
      background: #2a3a4a;
      border: 2px solid #5e9eff;
      border-radius: 1rem;
      padding: 0.8rem;
      cursor: pointer;
      text-align: center;
    }
    .choice-btn:hover {
      background: #3b6eff;
    }
    .answer-input {
      width: 100%;
      padding: 0.8rem;
      border-radius: 60px;
      border: 1px solid #3e5a77;
      background: #0f1a24;
      color: white;
      margin: 1rem 0;
    }
    .popup-timer {
      font-size: 2rem;
      color: #ffaa33;
      margin: 0.5rem 0;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>üéß Blind Test</h1>

    <!-- Vue H√îTE -->
    <div id="host-view" class="hidden">
      <div class="game-header">
        <span id="hostSongCounter" class="song-counter">Chanson 1 / ?</span>
        <button id="hostPlay" class="play-btn">‚ñ∂Ô∏è</button>
        <button id="hostReveal" class="reveal-btn">üîé R√©v√©ler</button>
      </div>
      <div class="timer-big" id="hostTimer">00:00.0</div>
      <div id="hostNotification" class="notification"></div>
      <div id="hostScoreboard" class="scoreboard"></div>
      <button id="hostNext" class="primary" disabled>‚è© Chanson suivante</button>
    </div>

    <!-- Vue JOUEUR -->
    <div id="player-view" class="hidden">
      <div id="playerSongInfo" style="text-align:center; margin-bottom:1rem;">Chanson 1 / ?</div>
      <div class="timer-big" id="playerTimer">00:00.0</div>
      <div id="playerScore" style="font-size:1.5rem; text-align:center; color:#d4ffb0; margin:0.5rem;">0 pts</div>
      <div id="playerAttempts" style="text-align:center;">Essais restants: ‚àû</div>
      <div id="cooldownDisplay" class="cooldown-timer"></div>
      <button class="buzzer-btn" id="playerBuzzer">JE SAIS !</button>
      <div id="playerFeedback" style="text-align:center;"></div>
    </div>

    <!-- Popup de r√©v√©lation (h√¥te) -->
    <div id="popupReveal" class="popup hidden">
      <h3>üéâ R√©ponse</h3>
      <img id="revealCover" class="popup-cover" src="" alt="cover">
      <h2 id="revealTitle"></h2>
      <p id="revealArtist"></p>
      <button id="closeReveal" class="primary">Fermer</button>
    </div>

    <!-- Popup r√©ponse √©crite -->
    <div id="popupAnswer" class="popup hidden">
      <h3>‚úèÔ∏è Tape le titre</h3>
      <input type="text" id="answerInput" class="answer-input" placeholder="Titre">
      <div style="display:flex; gap:1rem; align-items:center;">
        <button id="submitAnswer" style="flex:1;">‚úÖ Valider</button>
        <span id="answerTimer" class="popup-timer">10</span>
      </div>
    </div>

    <!-- Popup choix multiple -->
    <div id="popupChoice" class="popup hidden">
      <h3>üéØ Choisis la chanson</h3>
      <div id="choiceGrid" class="choice-grid"></div>
      <div id="choiceTimer" class="popup-timer">5</div>
    </div>

    <!-- Popup r√©sultat (bravo/faux) -->
    <div id="popupResult" class="popup hidden">
      <h3 id="resultTitle"></h3>
      <p id="resultMessage"></p>
    </div>

    <!-- Popup pour le mode artiste -->
    <div id="popupArtist" class="popup hidden">
      <h3>üé§ Quel artiste ?</h3>
      <div id="artistGrid" class="choice-grid"></div>
    </div>

    <!-- Popup pour le mode date -->
    <div id="popupDate" class="popup hidden">
      <h3>üìÖ De quelle √©poque ?</h3>
      <div id="dateGrid" class="choice-grid"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    (function() {
      // ==================== CONFIGURATION FIREBASE ====================
      const firebaseConfig = {
        apiKey: "AIzaSyBOEU9kg6YuXllGEGS9iod_SsBRu9NOPro",
        authDomain: "blind-test-kahoot.firebaseapp.com",
        databaseURL: "https://blind-test-kahoot-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "blind-test-kahoot",
        storageBucket: "blind-test-kahoot.firebasestorage.app",
        messagingSenderId: "798773649205",
        appId: "1:798773649205:web:de5dd5cbce41ea2ec5b67c"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ==================== R√âCUP√âRATION DE L'√âTAT LOCAL ====================
      const roomCode = sessionStorage.getItem('blindtest_roomCode');
      const isHost = sessionStorage.getItem('blindtest_isHost') === 'true';
      const clientId = sessionStorage.getItem('blindtest_clientId');
      const playerName = sessionStorage.getItem('blindtest_playerName') || 'Joueur';

      if (!roomCode) {
        alert('Aucune partie en cours. Retour √† l\'accueil.');
        window.location.href = 'index.html';
        return;
      }

      console.log('Jeu d√©marr√©', { roomCode, isHost, clientId, playerName });

      const roomRef = db.ref('rooms/' + roomCode);
      const gameStateRef = roomRef.child('gameState');
      const playersRef = roomRef.child('players');

      // ==================== VARIABLES PARTAG√âES ====================
      let currentAudio = null;
      let gameSongs = [];
      let currentSongIndex = 0;
      let roundActive = false;
      let roundStartTime = 0;
      let scores = {};
      let playerAttempts = {};
      let buzzer = null;
      let mode = 'classic';
      let maxAttempts = 3;
      let blurEnabled = false;

      // Intervalles
      let answerTimerInterval = null;
      let choiceTimerInterval = null;
      let answerStartTime = 0;

      // ==================== FONCTIONS UTILITAIRES ====================
      function normalize(str) {
        if (!str) return '';
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/[^a-z0-9]/g, "");
      }
      function formatTimer(ms) {
        if (ms < 0) ms = 0;
        let seconds = Math.floor(ms / 1000);
        let tenth = Math.floor((ms % 1000) / 100);
        let minutes = Math.floor(seconds / 60);
        seconds = seconds % 60;
        return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}.${tenth}`;
      }
      function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }
      function getCooldown(attemptCount) {
        return 3000 + (attemptCount - 1) * 2000; // 3s, 5s, 7s...
      }

      // ==================== AFFICHAGE DE LA BONNE VUE ====================
      const hostView = document.getElementById('host-view');
      const playerView = document.getElementById('player-view');
      if (isHost) {
        hostView.classList.remove('hidden');
        initHost();
      } else {
        playerView.classList.remove('hidden');
        initPlayer();
      }

      // ==================== √âCOUTE GLOBALE DE L'√âTAT ====================
      gameStateRef.on('value', (snap) => {
        const gs = snap.val() || {};
        gameSongs = gs.songs || [];
        currentSongIndex = gs.currentSongIndex || 0;
        roundActive = gs.roundActive || false;
        roundStartTime = gs.roundStartTime || 0;
        scores = gs.scores || {};
        playerAttempts = gs.playerAttempts || {};
        buzzer = gs.buzzer;
        mode = gs.mode || 'classic';
        maxAttempts = gs.maxAttempts || 3;
        blurEnabled = gs.blurEnabled || false;

        // Mettre √† jour les interfaces
        if (isHost) {
          updateHostUI();
        } else {
          updatePlayerUI();
        }
      });

      // ==================== H√îTE ====================
      function initHost() {
        const hostSongCounter = document.getElementById('hostSongCounter');
        const hostTimer = document.getElementById('hostTimer');
        const hostNotification = document.getElementById('hostNotification');
        const hostScoreboard = document.getElementById('hostScoreboard');
        const hostNext = document.getElementById('hostNext');
        const hostPlay = document.getElementById('hostPlay');
        const hostReveal = document.getElementById('hostReveal');

        // Timer en continu
        setInterval(() => {
          if (roundActive && roundStartTime > 0) {
            const elapsed = Date.now() - roundStartTime;
            hostTimer.textContent = formatTimer(elapsed);
          }
        }, 100);

        function updateHostUI() {
          if (gameSongs.length > 0) {
            hostSongCounter.textContent = `Chanson ${currentSongIndex+1} / ${gameSongs.length}`;
          }
          updateHostScoreboard();
          hostNext.disabled = roundActive; // On ne peut passer que quand le round est fini
        }

        function updateHostScoreboard() {
          playersRef.once('value', (snap) => {
            const players = snap.val() || {};
            let html = '<strong>Scores :</strong><br>';
            Object.entries(players).forEach(([id, p]) => {
              html += `<div>${p.avatar || ''} ${p.name}: ${scores[id] || 0} pts</div>`;
            });
            hostScoreboard.innerHTML = html;
          });
        }

        hostPlay.addEventListener('click', () => {
          if (roundActive) return;
          const startTime = Date.now();
          gameStateRef.update({
            roundStartTime: startTime,
            roundActive: true,
            buzzer: null
          });
          // Lecture de l'extrait
          const song = gameSongs[currentSongIndex];
          if (song && song.previewUrl) {
            if (currentAudio) currentAudio.pause();
            currentAudio = new Audio(song.previewUrl);
            currentAudio.play().catch(e => {
              console.log('Erreur lecture audio', e);
              alert('Impossible de lire l\'extrait audio.');
            });
          } else {
            alert('Aucun extrait disponible pour cette chanson.');
          }
        });

        // R√©v√©lation avec popup jolie
        hostReveal.addEventListener('click', () => {
          const song = gameSongs[currentSongIndex];
          if (!song) return;
          const popup = document.getElementById('popupReveal');
          const cover = document.getElementById('revealCover');
          const title = document.getElementById('revealTitle');
          const artist = document.getElementById('revealArtist');
          cover.src = song.artwork || 'https://via.placeholder.com/120';
          if (blurEnabled) cover.classList.add('blur');
          else cover.classList.remove('blur');
          title.textContent = song.title;
          artist.textContent = song.artist;
          popup.classList.remove('hidden');
        });

        document.getElementById('closeReveal').addEventListener('click', () => {
          document.getElementById('popupReveal').classList.add('hidden');
        });

        hostNext.addEventListener('click', () => {
          if (currentSongIndex + 1 < gameSongs.length) {
            gameStateRef.update({
              currentSongIndex: currentSongIndex + 1,
              roundActive: false,
              buzzer: null
            });
          } else {
            alert('Fin du jeu ! Redirection vers le podium...');
            // Rediriger vers results.html (√† cr√©er)
          }
        });

        // Affichage des r√©sultats de r√©ponse
        gameStateRef.child('answerResult').on('value', (snap) => {
          const res = snap.val();
          if (res) {
            playersRef.child(res.playerId).once('value', (pSnap) => {
              const player = pSnap.val();
              if (player) {
                hostNotification.textContent = `${player.name}: ${res.correct ? '‚úÖ' : '‚ùå'} ${res.points} pts`;
                setTimeout(() => hostNotification.textContent = '', 3000);
              }
            });
            snap.ref.remove(); // nettoyer
          }
        });
      }

      // ==================== JOUEUR ====================
      function initPlayer() {
        const playerSongInfo = document.getElementById('playerSongInfo');
        const playerTimer = document.getElementById('playerTimer');
        const playerScore = document.getElementById('playerScore');
        const playerAttemptsDiv = document.getElementById('playerAttempts');
        const cooldownDisplay = document.getElementById('cooldownDisplay');
        const playerBuzzer = document.getElementById('playerBuzzer');
        const playerFeedback = document.getElementById('playerFeedback');

        // Timer en continu
        setInterval(() => {
          if (roundActive && roundStartTime > 0) {
            const elapsed = Date.now() - roundStartTime;
            playerTimer.textContent = formatTimer(elapsed);
          }
        }, 100);

        function updatePlayerUI() {
          if (gameSongs[currentSongIndex]) {
            playerSongInfo.textContent = `Chanson ${currentSongIndex+1} / ${gameSongs.length}`;
          }
          playerScore.textContent = (scores[clientId] || 0) + ' pts';

          const attempts = playerAttempts[clientId] || { attemptsLeft: maxAttempts, cooldownUntil: 0, attemptCount: 0 };
          playerAttemptsDiv.textContent = `Essais restants: ${maxAttempts === 0 ? '‚àû' : attempts.attemptsLeft}`;

          const now = Date.now();
          if (attempts.cooldownUntil && now < attempts.cooldownUntil) {
            const sec = Math.ceil((attempts.cooldownUntil - now)/1000);
            cooldownDisplay.textContent = `‚è≥ Cooldown: ${sec}s`;
            playerBuzzer.disabled = true;
            playerFeedback.textContent = '';
          } else {
            cooldownDisplay.textContent = '';
            if (buzzer) {
              if (buzzer === clientId) {
                playerBuzzer.disabled = true;
                playerFeedback.textContent = '';
              } else {
                playerBuzzer.disabled = true;
                playerFeedback.textContent = '‚è≥ Quelqu\'un a buzz√©...';
              }
            } else {
              if (maxAttempts > 0 && attempts.attemptsLeft <= 0) {
                playerBuzzer.disabled = true;
                playerFeedback.textContent = '‚ùå Plus d\'essais';
              } else {
                playerBuzzer.disabled = false;
                playerFeedback.textContent = '';
              }
            }
          }
        }

        playerBuzzer.addEventListener('click', () => {
          if (playerBuzzer.disabled) return;
          const attempts = playerAttempts[clientId] || { attemptsLeft: maxAttempts, cooldownUntil: 0, attemptCount: 0 };
          const now = Date.now();
          if (attempts.cooldownUntil && now < attempts.cooldownUntil) return;
          if (maxAttempts > 0 && attempts.attemptsLeft <= 0) return;
          gameStateRef.update({ buzzer: clientId });
        });

        // Quand le buzzer est pris par ce joueur
        gameStateRef.child('buzzer').on('value', (snap) => {
          const currentBuzzer = snap.val();
          if (currentBuzzer === clientId) {
            playerBuzzer.disabled = true;
            // Afficher la popup selon le mode
            if (mode === 'kahoot') {
              showChoicePopup();
            } else if (mode === 'artist') {
              showArtistPopup();
            } else if (mode === 'date') {
              showDatePopup();
            } else {
              showAnswerPopup();
            }
          }
        });

        // ===== Popup r√©ponse √©crite =====
        function showAnswerPopup() {
          const popup = document.getElementById('popupAnswer');
          const input = document.getElementById('answerInput');
          const timerSpan = document.getElementById('answerTimer');
          popup.classList.remove('hidden');
          input.value = '';
          input.focus();
          let timeLeft = 10;
          timerSpan.textContent = timeLeft;
          answerStartTime = Date.now();
          if (answerTimerInterval) clearInterval(answerTimerInterval);
          answerTimerInterval = setInterval(() => {
            timeLeft--;
            timerSpan.textContent = timeLeft;
            if (timeLeft <= 0) {
              clearInterval(answerTimerInterval);
              submitAnswer('');
            }
          }, 1000);
        }

        document.getElementById('submitAnswer').onclick = () => {
          const ans = document.getElementById('answerInput').value.trim();
          submitAnswer(ans);
        };

        async function submitAnswer(answer) {
          if (answerTimerInterval) clearInterval(answerTimerInterval);
          document.getElementById('popupAnswer').classList.add('hidden');
          const song = gameSongs[currentSongIndex];
          if (!song) return;
          const correct = song.title;
          const normAnswer = normalize(answer);
          const normCorrect = normalize(correct);
          const isCorrect = normAnswer === normCorrect || normCorrect.includes(normAnswer) || normAnswer.includes(normCorrect);
          const elapsed = roundActive ? Date.now() - roundStartTime : 0;
          let points = 0;
          if (isCorrect) {
            if (mode === 'kahoot') {
              const seconds = elapsed / 1000;
              points = Math.max(20, 100 - Math.floor(seconds * 10));
            } else {
              points = 50;
            }
          } else {
            points = -50;
          }
          await sendResult(points, isCorrect, correct, elapsed);
        }

        // ===== Popup choix multiple =====
        function showChoicePopup() {
          const currentSong = gameSongs[currentSongIndex];
          if (!currentSong) return;
          // G√©n√©rer des propositions : la bonne + 3 autres al√©atoires (parmi toutes les chansons)
          let otherSongs = gameSongs.filter(s => s.title !== currentSong.title);
          while (otherSongs.length < 3) {
            otherSongs = otherSongs.concat(gameSongs);
          }
          shuffleArray(otherSongs);
          const choices = [currentSong, ...otherSongs.slice(0, 3)];
          shuffleArray(choices);
          const grid = document.getElementById('choiceGrid');
          grid.innerHTML = '';
          choices.forEach((song, idx) => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = song.title;
            btn.onclick = () => handleChoice(song, currentSong);
            grid.appendChild(btn);
          });
          document.getElementById('popupChoice').classList.remove('hidden');
          let timeLeft = 5;
          document.getElementById('choiceTimer').textContent = timeLeft;
          if (choiceTimerInterval) clearInterval(choiceTimerInterval);
          choiceTimerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('choiceTimer').textContent = timeLeft;
            if (timeLeft <= 0) {
              clearInterval(choiceTimerInterval);
              handleChoice(null, currentSong);
            }
          }, 1000);
        }

        async function handleChoice(selected, correct) {
          if (choiceTimerInterval) clearInterval(choiceTimerInterval);
          document.getElementById('popupChoice').classList.add('hidden');
          const isCorrect = selected && selected.title === correct.title;
          const elapsed = roundActive ? Date.now() - roundStartTime : 0;
          let points = 0;
          if (isCorrect) {
            const seconds = elapsed / 1000;
            points = Math.max(20, 100 - Math.floor(seconds * 10));
          } else {
            points = -50;
          }
          await sendResult(points, isCorrect, correct.title, elapsed);
        }

        // ===== Popup artiste =====
        function showArtistPopup() {
          // Simuler une liste d'artistes (on pourrait les prendre depuis les chansons)
          const artists = [...new Set(gameSongs.map(s => s.artist))];
          if (artists.length === 0) {
            // fallback
            artists.push('Inconnu');
          }
          shuffleArray(artists);
          const grid = document.getElementById('artistGrid');
          grid.innerHTML = '';
          artists.forEach(artist => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = artist;
            btn.onclick = () => handleArtistChoice(artist);
            grid.appendChild(btn);
          });
          document.getElementById('popupArtist').classList.remove('hidden');
        }

        async function handleArtistChoice(selectedArtist) {
          document.getElementById('popupArtist').classList.add('hidden');
          const song = gameSongs[currentSongIndex];
          const isCorrect = song.artist.toLowerCase() === selectedArtist.toLowerCase();
          const points = isCorrect ? 50 : -50;
          await sendResult(points, isCorrect, song.artist, 0);
        }

        // ===== Popup date =====
        function showDatePopup() {
          const eras = [
            { label: 'Avant 1980', min: 1900, max: 1979 },
            { label: '1980-2000', min: 1980, max: 1999 },
            { label: '2000-2010', min: 2000, max: 2009 },
            { label: '2010-2020', min: 2010, max: 2019 },
            { label: 'Apr√®s 2020', min: 2020, max: 2030 }
          ];
          const grid = document.getElementById('dateGrid');
          grid.innerHTML = '';
          eras.forEach(era => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = era.label;
            btn.onclick = () => handleDateChoice(era);
            grid.appendChild(btn);
          });
          document.getElementById('popupDate').classList.remove('hidden');
        }

        async function handleDateChoice(selectedEra) {
          document.getElementById('popupDate').classList.add('hidden');
          // Pour cet exemple, on n'a pas l'ann√©e, on simule
          const songYear = 2015; // √Ä remplacer par une vraie donn√©e
          const isCorrect = songYear >= selectedEra.min && songYear <= selectedEra.max;
          const points = isCorrect ? 50 : -50;
          await sendResult(points, isCorrect, selectedEra.label, 0);
        }

        // ===== Envoi du r√©sultat =====
        async function sendResult(points, isCorrect, correctInfo, elapsed) {
          scores[clientId] = (scores[clientId] || 0) + points;
          let attempts = playerAttempts[clientId] || { attemptsLeft: maxAttempts, cooldownUntil: 0, attemptCount: 0 };
          if (maxAttempts > 0 && !isCorrect) {
            attempts.attemptsLeft = Math.max(0, attempts.attemptsLeft - 1);
            attempts.attemptCount = (attempts.attemptCount || 0) + 1;
            attempts.cooldownUntil = Date.now() + getCooldown(attempts.attemptCount);
          }
          if (isCorrect) {
            attempts.attemptsLeft = 0;
            attempts.cooldownUntil = 0;
          }
          playerAttempts[clientId] = attempts;

          await gameStateRef.update({
            scores: scores,
            playerAttempts: playerAttempts,
            answerResult: { playerId: clientId, correct: isCorrect, points, correctInfo, playerName: playerName },
            buzzer: null
          });

          // Afficher la popup de r√©sultat
          const popup = document.getElementById('popupResult');
          const titleEl = document.getElementById('resultTitle');
          const msgEl = document.getElementById('resultMessage');
          if (isCorrect) {
            titleEl.textContent = 'üéâ Bravo !';
            msgEl.innerHTML = `+${points} points`;
          } else {
            titleEl.textContent = '‚ùå Faux !';
            msgEl.innerHTML = `-50 points<br>R√©ponse : ${correctInfo}`;
          }
          popup.classList.remove('hidden');
          setTimeout(() => popup.classList.add('hidden'), 3000);
        }
      }
    })();
  </script>
</body>
</html>