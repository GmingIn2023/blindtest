<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Test Buzz & Mix</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, sans-serif;
    }
    body {
      background: #0a0c0e;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }
    #app {
      max-width: 600px;
      width: 100%;
      background: #151a1f;
      border-radius: 2rem;
      padding: 1.8rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
    }
    h1 { text-align: center; margin-bottom: 1.5rem; }
    .phase { display: none; }
    .phase.active { display: block; }
    button, input {
      background: #1e2a36;
      border: 1px solid #3a4a5a;
      border-radius: 60px;
      padding: 0.8rem 1.2rem;
      color: white;
      width: 100%;
      margin: 0.5rem 0;
      font-size: 1rem;
    }
    button.primary { background: #3b6eff; }
    .room-code {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      background: #0f1a24;
      padding: 1rem;
      border-radius: 1.5rem;
      letter-spacing: 0.3rem;
      margin: 1rem 0;
    }
    .player-list {
      background: #0f1a24;
      border-radius: 1.5rem;
      padding: 1rem;
      margin: 1rem 0;
    }
    .player-tag {
      display: inline-block;
      background: #2a3a4a;
      padding: 0.4rem 1rem;
      border-radius: 60px;
      margin: 0.2rem;
    }
    .buzzer-btn {
      background: radial-gradient(circle at 30% 30%, #ff4d4d, #b30000);
      width: 200px;
      height: 200px;
      border-radius: 50%;
      margin: 2rem auto;
      font-size: 2rem;
      font-weight: bold;
      color: white;
      border: none;
      cursor: pointer;
      display: block;
    }
    .buzzer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e2a36;
      border: 3px solid #ffaa33;
      border-radius: 2rem;
      padding: 2rem;
      width: 90%;
      max-width: 400px;
      z-index: 1000;
    }
    .hidden { display: none !important; }
    .flex { display: flex; gap: 1rem; }
    .choice-grid {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 0.8rem;
      margin-top: 1rem;
    }
    .choice-btn {
      background: #2a3a4a;
      border: 2px solid #5e9eff;
      border-radius: 1rem;
      padding: 0.8rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- Phase accueil -->
  <div id="phase-home" class="phase active">
    <h1>üéß Test Buzz & Mix</h1>
    <button id="btn-host" class="primary">üéÆ Cr√©er (h√¥te)</button>
    <button id="btn-client">üì± Rejoindre (joueur)</button>
  </div>

  <!-- Phase configuration (h√¥te) -->
  <div id="phase-config" class="phase">
    <h2>Configuration</h2>
    <label>Nombre de joueurs (hors h√¥te)</label>
    <input type="number" id="player-count" min="1" max="4" value="1">
    <button id="start-btn" class="primary">Cr√©er la partie</button>
  </div>

  <!-- Lobby h√¥te -->
  <div id="phase-host-lobby" class="phase">
    <h2>Salon h√¥te</h2>
    <div class="room-code" id="roomCodeDisplay"></div>
    <div class="player-list">
      <div>Joueurs connect√©s :</div>
      <div id="connectedPlayersList"></div>
    </div>
    <button id="startGameBtn" disabled>‚è≥ En attente...</button>
  </div>

  <!-- Lobby joueur -->
  <div id="phase-player-lobby" class="phase">
    <h2>Rejoindre</h2>
    <input type="text" id="joinCode" placeholder="Code">
    <input type="text" id="joinName" placeholder="Ton nom" value="Joueur">
    <button id="joinBtn">Rejoindre</button>
    <div id="playerLobbyStatus"></div>
  </div>

  <!-- Jeu h√¥te -->
  <div id="phase-host-game" class="phase">
    <h2>H√¥te - jeu</h2>
    <div id="hostSongInfo">Chanson 1 / 3</div>
    <button id="hostPlay">‚ñ∂Ô∏è Jouer l'extrait</button>
    <button id="hostMix" style="background:#ffaa33;">üîÄ Mixer avec une autre</button>
    <div id="hostBuzzerInfo" style="margin:1rem 0; padding:0.5rem; background:#1e3f5a; border-radius:60px;"></div>
    <div id="hostScoreboard"></div>
    <button id="hostNext" disabled>‚è© Suivant</button>
  </div>

  <!-- Jeu joueur -->
  <div id="phase-player-game" class="phase">
    <h2>Joueur - en jeu</h2>
    <div id="playerSongInfo"></div>
    <button class="buzzer-btn" id="playerBuzzer">JE SAIS !</button>
    <div id="playerFeedback"></div>
  </div>

  <!-- Popup r√©ponse √©crite simple -->
  <div id="popupAnswer" class="popup hidden">
    <h3>‚úèÔ∏è Tape le titre</h3>
    <input type="text" id="answerInput" placeholder="Titre">
    <div class="flex" style="margin-top:1rem;">
      <button id="submitAnswer">Valider</button>
      <span id="timer" style="font-size:2rem;">10</span>
    </div>
  </div>

  <!-- Popup r√©ponse mix (deux titres) -->
  <div id="popupMix" class="popup hidden">
    <h3>üîÄ Deux chansons</h3>
    <p>√âcris les deux titres :</p>
    <input type="text" id="mixInput1" placeholder="Premier titre">
    <input type="text" id="mixInput2" placeholder="Deuxi√®me titre">
    <div class="flex" style="margin-top:1rem;">
      <button id="submitMix">Valider</button>
      <span id="mixTimer" style="font-size:2rem;">15</span>
    </div>
  </div>

  <!-- Popup choix multiple (mode Kahoot) - simple -->
  <div id="popupChoice" class="popup hidden">
    <h3>üéØ Choisis la chanson</h3>
    <div id="choiceGrid" class="choice-grid"></div>
    <div id="choiceTimer" style="text-align:center; font-size:2rem; margin-top:1rem;">5</div>
  </div>

  <!-- Popup choix multiple pour mix (deux choix) -->
  <div id="popupChoiceMix" class="popup hidden">
    <h3>üîÄ Choisis les deux chansons</h3>
    <p>Clique sur deux titres :</p>
    <div id="choiceMixGrid" class="choice-grid"></div>
    <div id="choiceMixTimer" style="text-align:center; font-size:2rem; margin-top:1rem;">15</div>
  </div>

  <canvas id="confetti" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; display:none;"></canvas>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
  (function(){
    "use strict";
    // === Configuration Firebase (identique) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBOEU9kg6YuXllGEGS9iod_SsBRu9NOPro",
      authDomain: "blind-test-kahoot.firebaseapp.com",
      databaseURL: "https://blind-test-kahoot-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "blind-test-kahoot",
      storageBucket: "blind-test-kahoot.firebasestorage.app",
      messagingSenderId: "798773649205",
      appId: "1:798773649205:web:de5dd5cbce41ea2ec5b67c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    console.log("Firebase pr√™t");

    // === √âtat ===
    const state = {
      roomCode: null,
      isHost: false,
      clientId: null,
      playerName: '',
      players: [],
      gameSongs: [
        { title: "Billie Jean", artist: "Michael Jackson", preview: "https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview125/v4/8d/2f/35/8d2f359f-9b0a-4b3a-9e8a-7a3b0c1d2e3f/mzf_1234567890_aac_p.m4a" },
        { title: "Shape of You", artist: "Ed Sheeran", preview: "https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview115/v4/1a/2b/3c/1a2b3c4d-5e6f-7g8h-9i0j-1k2l3m4n5o6p/mzf_9876543210_aac_p.m4a" },
        { title: "Uptown Funk", artist: "Bruno Mars", preview: "https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview125/v4/9a/8b/7c/9a8b7c6d-5e4f-3g2h-1i0j-9k8l7m6n5o4p/mzf_1122334455_aac_p.m4a" },
        { title: "Blinding Lights", artist: "The Weeknd", preview: "https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview125/v4/2a/3b/4c/2a3b4c5d-6e7f-8g9h-0i1j-2k3l4m5n6o7p/mzf_5566778899_aac_p.m4a" },
        { title: "Despacito", artist: "Luis Fonsi", preview: "https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview115/v4/5a/6b/7c/5a6b7c8d-9e0f-1g2h-3i4j-5k6l7m8n9o0p/mzf_9988776655_aac_p.m4a" }
      ],
      currentSongIndex: 0,
      currentSong: null,
      mixed: false,
      mixedSongs: [], // les deux chansons mix√©es
      roundActive: false,
      buzzerLocked: false,
      scores: {},
    };

    // === DOM helpers ===
    const $ = id => document.getElementById(id);
    const phases = {
      home: $('phase-home'),
      config: $('phase-config'),
      hostLobby: $('phase-host-lobby'),
      playerLobby: $('phase-player-lobby'),
      hostGame: $('phase-host-game'),
      playerGame: $('phase-player-game'),
    };
    function showPhase(name) {
      Object.values(phases).forEach(p => p.classList.remove('active'));
      phases[name].classList.add('active');
    }

    // === G√©n√©ration code ===
    function generateCode() {
      return Math.random().toString(36).substring(2,6).toUpperCase();
    }

    // === Home ===
    $('btn-host').onclick = () => showPhase('config');
    $('btn-client').onclick = () => showPhase('playerLobby');

    // === Cr√©ation partie (h√¥te) ===
    $('start-btn').onclick = async () => {
      const playerCount = parseInt($('player-count').value, 10) || 1;
      state.roomCode = generateCode();
      state.isHost = true;
      state.clientId = 'host';
      try {
        const roomRef = db.ref('rooms/' + state.roomCode);
        await roomRef.set({
          players: {},
          gameState: {
            currentSongIndex: 0,
            songs: state.gameSongs,
            scores: {},
            buzzer: null,
            mixed: false,
            mixedSongs: [],
          },
          status: 'lobby',
          createdAt: Date.now(),
        });
        // √âcouter les joueurs
        roomRef.child('players').on('value', (snap) => {
          const players = snap.val() || {};
          state.players = Object.entries(players).map(([id, p]) => ({ id, ...p }));
          updateHostLobby();
        });
        // √âcouter gameState
        roomRef.child('gameState').on('value', (snap) => {
          const gs = snap.val() || {};
          state.currentSongIndex = gs.currentSongIndex || 0;
          state.gameSongs = gs.songs || state.gameSongs;
          state.scores = gs.scores || {};
          state.mixed = gs.mixed || false;
          state.mixedSongs = gs.mixedSongs || [];
          state.buzzerLocked = !!gs.buzzer;
          if (state.isHost) updateHostGame();
        });
        $('roomCodeDisplay').textContent = state.roomCode;
        showPhase('hostLobby');
      } catch(e) { alert('Erreur cr√©ation: '+e.message); }
    };

    function updateHostLobby() {
      const list = $('connectedPlayersList');
      list.innerHTML = state.players.map(p => `<span class="player-tag">${p.name}</span>`).join('');
      const btn = $('startGameBtn');
      if (state.players.length >= parseInt($('player-count').value)) {
        btn.disabled = false;
        btn.textContent = 'D√©marrer le jeu';
        btn.onclick = async () => {
          const roomRef = db.ref('rooms/' + state.roomCode);
          await roomRef.update({ status: 'game' });
          showPhase('hostGame');
          updateHostGame();
        };
      } else {
        btn.disabled = true;
        btn.textContent = `En attente de ${parseInt($('player-count').value) - state.players.length} joueur(s)`;
      }
    }

    // === Rejoindre (joueur) ===
    $('joinBtn').onclick = async () => {
      const code = $('joinCode').value.trim().toUpperCase();
      const name = $('joinName').value.trim() || 'Joueur';
      if (!code) return alert('Entre un code');
      state.roomCode = code;
      state.playerName = name;
      state.clientId = 'player_' + Date.now() + '_' + Math.random().toString(36).substring(2);
      try {
        const roomRef = db.ref('rooms/' + code);
        const snap = await roomRef.once('value');
        if (!snap.exists()) return alert('Partie introuvable');
        const data = snap.val();
        if (data.status !== 'lobby') return alert('Partie d√©j√† commenc√©e');
        await roomRef.child('players/' + state.clientId).set({ name, joinedAt: Date.now() });
        // √âcouter les changements
        roomRef.child('status').on('value', (snap) => {
          if (snap.val() === 'game') {
            showPhase('playerGame');
            initPlayerGame();
          }
        });
        roomRef.child('gameState').on('value', (snap) => {
          const gs = snap.val() || {};
          state.currentSongIndex = gs.currentSongIndex || 0;
          state.gameSongs = gs.songs || [];
          state.scores = gs.scores || {};
          state.mixed = gs.mixed || false;
          state.mixedSongs = gs.mixedSongs || [];
          if ($('playerSongInfo')) {
            const song = state.gameSongs[state.currentSongIndex];
            $('playerSongInfo').textContent = `Chanson ${state.currentSongIndex+1} / ${state.gameSongs.length}`;
          }
          if ($('playerScoreDisplay')) {
            $('playerScoreDisplay').textContent = (state.scores[state.clientId] || 0) + ' pts';
          }
          // Gestion du buzzer
          if (gs.buzzer === state.clientId) {
            // C'est moi qui ai buzz√©
            $('playerBuzzer').disabled = true;
            if (state.mixed) {
              showMixPopup();
            } else {
              showAnswerPopup();
            }
          } else if (gs.buzzer) {
            $('playerBuzzer').disabled = true;
            $('playerFeedback').textContent = '‚è≥ Quelqu\'un a buzz√©...';
          } else {
            $('playerBuzzer').disabled = false;
            $('playerFeedback').textContent = '';
          }
        });
        $('playerLobbyStatus').innerHTML = 'Connect√©, attente du d√©but...';
      } catch(e) { alert('Erreur connexion: '+e.message); }
    };

    function initPlayerGame() {
      $('playerBuzzer').disabled = false;
      $('playerFeedback').textContent = '';
    }

    // === Bouton Je sais (joueur) ===
    $('playerBuzzer').onclick = async () => {
      if ($('playerBuzzer').disabled) return;
      $('playerBuzzer').disabled = true;
      const roomRef = db.ref('rooms/' + state.roomCode);
      await roomRef.child('gameState/buzzer').set(state.clientId);
    };

    // === Popup r√©ponse simple ===
    let answerTimer = null;
    function showAnswerPopup() {
      $('popupAnswer').classList.remove('hidden');
      $('answerInput').value = '';
      $('answerInput').focus();
      let timeLeft = 10;
      $('timer').textContent = timeLeft;
      if (answerTimer) clearInterval(answerTimer);
      answerTimer = setInterval(() => {
        timeLeft--;
        $('timer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(answerTimer);
          submitAnswer(''); // timeout
        }
      }, 1000);
    }

    $('submitAnswer').onclick = () => {
      const ans = $('answerInput').value.trim();
      submitAnswer(ans);
    };

    async function submitAnswer(answer) {
      if (answerTimer) clearInterval(answerTimer);
      $('popupAnswer').classList.add('hidden');
      const roomRef = db.ref('rooms/' + state.roomCode);
      const song = state.gameSongs[state.currentSongIndex];
      const correct = song.title.toLowerCase().trim();
      const isCorrect = answer.toLowerCase().includes(correct) || correct.includes(answer.toLowerCase());
      const timeElapsed = 10 - parseInt($('timer').textContent);
      let points = 0;
      if (isCorrect) {
        points = Math.max(100, 500 - timeElapsed * 40);
      } else {
        points = -50;
      }
      const scores = state.scores;
      scores[state.clientId] = (scores[state.clientId] || 0) + points;
      await roomRef.child('gameState').update({
        scores: scores,
        answerResult: { playerId: state.clientId, correct: isCorrect, points, correctTitle: song.title },
        buzzer: null,
      });
      $('playerFeedback').innerHTML = isCorrect ? `‚úÖ +${points}` : `‚ùå -50 (c'√©tait ${song.title})`;
    }

    // === Popup mix (deux titres) ===
    let mixTimer = null;
    function showMixPopup() {
      $('popupMix').classList.remove('hidden');
      $('mixInput1').value = '';
      $('mixInput2').value = '';
      $('mixInput1').focus();
      let timeLeft = 15;
      $('mixTimer').textContent = timeLeft;
      if (mixTimer) clearInterval(mixTimer);
      mixTimer = setInterval(() => {
        timeLeft--;
        $('mixTimer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(mixTimer);
          submitMix('', '');
        }
      }, 1000);
    }

    $('submitMix').onclick = () => {
      const ans1 = $('mixInput1').value.trim();
      const ans2 = $('mixInput2').value.trim();
      submitMix(ans1, ans2);
    };

    async function submitMix(ans1, ans2) {
      if (mixTimer) clearInterval(mixTimer);
      $('popupMix').classList.add('hidden');
      const song1 = state.mixedSongs[0];
      const song2 = state.mixedSongs[1];
      const correct1 = song1.title.toLowerCase().trim();
      const correct2 = song2.title.toLowerCase().trim();
      const a1 = ans1.toLowerCase();
      const a2 = ans2.toLowerCase();
      const ok1 = a1.includes(correct1) || correct1.includes(a1);
      const ok2 = a2.includes(correct2) || correct2.includes(a2);
      let correctCount = (ok1?1:0) + (ok2?1:0);
      let points = 0;
      if (correctCount === 2) points = 100;
      else if (correctCount === 1) points = 0;
      else points = -50;
      const scores = state.scores;
      scores[state.clientId] = (scores[state.clientId] || 0) + points;
      const roomRef = db.ref('rooms/' + state.roomCode);
      await roomRef.child('gameState').update({
        scores: scores,
        answerResult: { playerId: state.clientId, correct: correctCount, points },
        buzzer: null,
        mixed: false,
        mixedSongs: [],
      });
      $('playerFeedback').innerHTML = points > 0 ? `‚úÖ +${points}` : (points === 0 ? `üü∞ 0 pt` : `‚ùå -50`);
    }

    // === Jeu h√¥te ===
    function updateHostGame() {
      const song = state.gameSongs[state.currentSongIndex];
      $('hostSongInfo').textContent = `Chanson ${state.currentSongIndex+1} / ${state.gameSongs.length} - ${song.title}`;
      let scoresHtml = '';
      state.players.forEach(p => {
        scoresHtml += `<div>${p.name}: ${state.scores[p.id] || 0} pts</div>`;
      });
      $('hostScoreboard').innerHTML = scoresHtml;
      $('hostBuzzerInfo').textContent = state.buzzerLocked ? 'üîí Buzz en cours' : '';
      $('hostNext').disabled = state.buzzerLocked;
    }

    $('hostPlay').onclick = () => {
      const song = state.gameSongs[state.currentSongIndex];
      if (song.preview) {
        new Audio(song.preview).play().catch(() => alert('Impossible de lire'));
      } else alert('Pas d\'extrait');
    };

    $('hostMix').onclick = async () => {
      if (state.gameSongs.length < 2) return alert('Pas assez de chansons');
      // Choisir une autre chanson al√©atoire (pas la courante)
      let otherIndex;
      do {
        otherIndex = Math.floor(Math.random() * state.gameSongs.length);
      } while (otherIndex === state.currentSongIndex);
      const mixed = [state.gameSongs[state.currentSongIndex], state.gameSongs[otherIndex]];
      const roomRef = db.ref('rooms/' + state.roomCode);
      await roomRef.child('gameState').update({
        mixed: true,
        mixedSongs: mixed,
      });
    };

    $('hostNext').onclick = async () => {
      if (state.currentSongIndex + 1 < state.gameSongs.length) {
        const next = state.currentSongIndex + 1;
        const roomRef = db.ref('rooms/' + state.roomCode);
        await roomRef.child('gameState').update({
          currentSongIndex: next,
          buzzer: null,
          mixed: false,
          mixedSongs: [],
        });
      } else {
        alert('Fin du jeu');
      }
    };

    // √âcouter buzzer pour h√¥te
    function listenBuzzer() {
      const roomRef = db.ref('rooms/' + state.roomCode);
      roomRef.child('gameState/buzzer').on('value', (snap) => {
        const buzzerId = snap.val();
        if (buzzerId && state.isHost) {
          $('hostBuzzerInfo').textContent = `üîî Joueur a buzz√© !`;
          // On pourrait afficher le nom du joueur
          const player = state.players.find(p => p.id === buzzerId);
          if (player) $('hostBuzzerInfo').textContent = `üîî ${player.name} a buzz√© !`;
        }
      });
    }
    // √Ä appeler apr√®s cr√©ation de partie
    setTimeout(() => { if (state.roomCode) listenBuzzer(); }, 1000);
  })();
</script>
</body>
</html>