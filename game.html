<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jeu ¬∑ Blind Test</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; gap: 1rem; flex-wrap: wrap; }
    .play-btn { background: linear-gradient(135deg, #5e9eff 0%, #2a5bbf 100%); width: 80px; height: 80px; border-radius: 50%; font-size: 2rem; border: none; color: white; cursor: pointer; }
    .reveal-btn { background: linear-gradient(135deg, #2e3b4e, #1e2835); border: 2px solid #3e4c5a; padding: 0.9rem 2rem; border-radius: 60px; }
    .timer-big { font-size: 2.5rem; font-weight: bold; color: #ffaa33; text-align: center; font-family: monospace; background: #0f1a24; padding: 0.5rem; border-radius: 1rem; margin: 1rem 0; }
    .buzzer-btn { background: radial-gradient(circle at 30% 30%, #ff4d4d, #b30000); width: 200px; height: 200px; border-radius: 50%; margin: 2rem auto; font-size: 2rem; font-weight: bold; color: white; border: none; cursor: pointer; display: block; }
    .buzzer-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e2a36; border: 3px solid #ffaa33; border-radius: 2rem; padding: 2rem; width: 90%; max-width: 400px; z-index: 1000; box-shadow: 0 10px 30px black; }
    .hidden { display: none !important; }
    .choice-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 0.5rem; }
    .choice-btn { background: #2a3a4a; border: 2px solid #5e9eff; border-radius: 1rem; padding: 0.8rem; cursor: pointer; text-align: center; }
    .choice-btn:hover { background: #3b6eff; }
    .scoreboard { background: #0f1419; border-radius: 1.5rem; padding: 1rem; margin: 1rem 0; }
    .notification { background: #1e3f5a; border-radius: 60px; padding: 0.5rem 1rem; margin: 0.5rem 0; text-align: center; }
    .cooldown-timer { font-size: 1.2rem; color: #ffaa33; text-align: center; }
  </style>
</head>
<body>
  <div id="app">
    <h1>üéß Jeu en cours</h1>

    <!-- Vue H√¥te -->
    <div id="host-view" class="hidden">
      <div class="game-header">
        <span id="hostSongCounter" class="song-counter">Chanson 1 / ?</span>
        <button id="hostPlay" class="play-btn">‚ñ∂Ô∏è</button>
        <button id="hostReveal" class="reveal-btn">üîé R√©v√©ler</button>
      </div>
      <div class="timer-big" id="hostTimer">00:00.0</div>
      <div id="hostNotification" class="notification"></div>
      <div id="hostScoreboard" class="scoreboard"></div>
      <button id="hostNext" class="primary" disabled>‚è© Chanson suivante</button>
    </div>

    <!-- Vue Joueur -->
    <div id="player-view" class="hidden">
      <div id="playerSongInfo" style="text-align:center; margin-bottom:1rem;">Chanson 1 / ?</div>
      <div class="timer-big" id="playerTimer">00:00.0</div>
      <div id="playerScore" style="font-size:1.5rem; text-align:center; color:#d4ffb0; margin:0.5rem;">0 pts</div>
      <div id="playerAttempts" style="text-align:center;">Essais restants: ‚àû</div>
      <div id="cooldownDisplay" class="cooldown-timer"></div>
      <button class="buzzer-btn" id="playerBuzzer">JE SAIS !</button>
      <div id="playerFeedback" style="text-align:center;"></div>
    </div>

    <!-- Popup r√©ponse √©crite -->
    <div id="popupAnswer" class="popup hidden">
      <h3 style="text-align:center;">‚úèÔ∏è Tape le titre</h3>
      <input type="text" id="answerInput" placeholder="Titre" style="width:100%; margin:1rem 0;">
      <div style="display:flex; gap:1rem; align-items:center;">
        <button id="submitAnswer" style="flex:1;">‚úÖ Valider</button>
        <span id="answerTimer" class="timer-big" style="font-size:1.8rem;">10</span>
      </div>
    </div>

    <!-- Popup choix multiple -->
    <div id="popupChoice" class="popup hidden">
      <h3 style="text-align:center;">üéØ Choisis la chanson</h3>
      <div id="choiceGrid" class="choice-grid"></div>
      <div id="choiceTimer" class="timer-big" style="margin-top:1rem;">5</div>
    </div>

    <!-- Popup de r√©sultat -->
    <div id="popupResult" class="popup hidden">
      <h3 id="resultTitle" style="text-align:center;"></h3>
      <p id="resultMessage" style="text-align:center;"></p>
    </div>

    <p style="text-align:center; margin-top:1.5rem;">
      <a href="index.html" style="color:#8aaec0;">‚Üê Quitter la partie</a>
    </p>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    (function() {
      // Configuration Firebase (√† adapter si besoin)
      const firebaseConfig = {
        apiKey: "AIzaSyBOEU9kg6YuXllGEGS9iod_SsBRu9NOPro",
        authDomain: "blind-test-kahoot.firebaseapp.com",
        databaseURL: "https://blind-test-kahoot-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "blind-test-kahoot",
        storageBucket: "blind-test-kahoot.firebasestorage.app",
        messagingSenderId: "798773649205",
        appId: "1:798773649205:web:de5dd5cbce41ea2ec5b67c"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // R√©cup√©ration de l'√©tat local depuis sessionStorage
      const roomCode = sessionStorage.getItem('blindtest_roomCode');
      const isHost = sessionStorage.getItem('blindtest_isHost') === 'true';
      const clientId = sessionStorage.getItem('blindtest_clientId');
      const playerName = sessionStorage.getItem('blindtest_playerName') || '';

      if (!roomCode) {
        alert('Aucune partie en cours. Retour √† l\'accueil.');
        window.location.href = 'index.html';
        return;
      }

      const roomRef = db.ref('rooms/' + roomCode);
      const gameStateRef = roomRef.child('gameState');
      const playersRef = roomRef.child('players');

      // √âl√©ments DOM
      const hostView = document.getElementById('host-view');
      const playerView = document.getElementById('player-view');

      // Variables partag√©es
      let currentAudio = null;
      let gameSongs = [];
      let currentSongIndex = 0;
      let roundActive = false;
      let roundStartTime = 0;
      let scores = {};
      let playerAttempts = {};
      let buzzer = null;
      let mode = 'classic';
      let maxAttempts = 3;

      // Intervalles pour les popups
      let answerTimerInterval = null;
      let choiceTimerInterval = null;
      let answerStartTime = 0;

      // Fonctions utilitaires
      function normalize(str) {
        if (!str) return '';
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/[^a-z0-9]/g, "");
      }
      function formatTimer(ms) {
        if (ms < 0) ms = 0;
        let seconds = Math.floor(ms / 1000);
        let tenth = Math.floor((ms % 1000) / 100);
        let minutes = Math.floor(seconds / 60);
        seconds = seconds % 60;
        return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}.${tenth}`;
      }
      function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }
      function getCooldown(attemptCount) {
        return 3000 + (attemptCount - 1) * 2000; // 3s, 5s, 7s...
      }

      // Initialisation selon le r√¥le
      if (isHost) {
        hostView.classList.remove('hidden');
        initHost();
      } else {
        playerView.classList.remove('hidden');
        initPlayer();
      }

      // ==================== H√îTE ====================
      function initHost() {
        const hostSongCounter = document.getElementById('hostSongCounter');
        const hostTimer = document.getElementById('hostTimer');
        const hostNotification = document.getElementById('hostNotification');
        const hostScoreboard = document.getElementById('hostScoreboard');
        const hostNext = document.getElementById('hostNext');
        const hostPlay = document.getElementById('hostPlay');
        const hostReveal = document.getElementById('hostReveal');

        gameStateRef.on('value', (snap) => {
          const gs = snap.val() || {};
          gameSongs = gs.songs || [];
          currentSongIndex = gs.currentSongIndex || 0;
          roundActive = gs.roundActive || false;
          roundStartTime = gs.roundStartTime || 0;
          scores = gs.scores || {};
          playerAttempts = gs.playerAttempts || {};
          buzzer = gs.buzzer;
          mode = gs.mode || 'classic';
          maxAttempts = gs.maxAttempts || 3;

          if (gameSongs.length > 0) {
            hostSongCounter.textContent = `Chanson ${currentSongIndex+1} / ${gameSongs.length}`;
          }
          updateHostScoreboard();
          hostNext.disabled = roundActive; // On ne peut passer que quand le round est fini
        });

        setInterval(() => {
          if (roundActive && roundStartTime > 0) {
            const elapsed = Date.now() - roundStartTime;
            hostTimer.textContent = formatTimer(elapsed);
          }
        }, 100);

        function updateHostScoreboard() {
          playersRef.once('value', (snap) => {
            const players = snap.val() || {};
            let html = '<strong>Scores:</strong><br>';
            Object.entries(players).forEach(([id, p]) => {
              html += `<div>${p.avatar || ''} ${p.name}: ${scores[id] || 0} pts</div>`;
            });
            hostScoreboard.innerHTML = html;
          });
        }

        hostPlay.addEventListener('click', () => {
          if (roundActive) return;
          const startTime = Date.now();
          gameStateRef.update({
            roundStartTime: startTime,
            roundActive: true,
            buzzer: null
          });
          if (gameSongs[currentSongIndex]?.preview) {
            if (currentAudio) currentAudio.pause();
            currentAudio = new Audio(gameSongs[currentSongIndex].preview);
            currentAudio.play().catch(e => console.log('Erreur lecture audio', e));
          }
        });

        hostReveal.addEventListener('click', () => {
          alert('R√©ponse : ' + (gameSongs[currentSongIndex]?.title || 'inconnue'));
        });

        hostNext.addEventListener('click', () => {
          if (currentSongIndex + 1 < gameSongs.length) {
            gameStateRef.update({
              currentSongIndex: currentSongIndex + 1,
              roundActive: false,
              buzzer: null
            });
          } else {
            alert('Fin du jeu !');
          }
        });

        gameStateRef.child('answerResult').on('value', (snap) => {
          const res = snap.val();
          if (res) {
            playersRef.child(res.playerId).once('value', (pSnap) => {
              const player = pSnap.val();
              if (player) {
                hostNotification.textContent = `${player.name}: ${res.correct ? '‚úÖ' : '‚ùå'} ${res.points} pts`;
                setTimeout(() => hostNotification.textContent = '', 3000);
              }
            });
            snap.ref.remove();
          }
        });
      }

      // ==================== JOUEUR ====================
      function initPlayer() {
        const playerSongInfo = document.getElementById('playerSongInfo');
        const playerTimer = document.getElementById('playerTimer');
        const playerScore = document.getElementById('playerScore');
        const playerAttemptsDiv = document.getElementById('playerAttempts');
        const cooldownDisplay = document.getElementById('cooldownDisplay');
        const playerBuzzer = document.getElementById('playerBuzzer');
        const playerFeedback = document.getElementById('playerFeedback');

        gameStateRef.on('value', (snap) => {
          const gs = snap.val() || {};
          gameSongs = gs.songs || [];
          currentSongIndex = gs.currentSongIndex || 0;
          roundActive = gs.roundActive || false;
          roundStartTime = gs.roundStartTime || 0;
          scores = gs.scores || {};
          playerAttempts = gs.playerAttempts || {};
          buzzer = gs.buzzer;
          mode = gs.mode || 'classic';
          maxAttempts = gs.maxAttempts || 3;

          updatePlayerUI();
        });

        setInterval(() => {
          if (roundActive && roundStartTime > 0) {
            const elapsed = Date.now() - roundStartTime;
            playerTimer.textContent = formatTimer(elapsed);
          }
        }, 100);

        function updatePlayerUI() {
          if (gameSongs[currentSongIndex]) {
            playerSongInfo.textContent = `Chanson ${currentSongIndex+1} / ${gameSongs.length}`;
          }
          playerScore.textContent = (scores[clientId] || 0) + ' pts';

          const attempts = playerAttempts[clientId] || { attemptsLeft: maxAttempts, cooldownUntil: 0, attemptCount: 0 };
          playerAttemptsDiv.textContent = `Essais restants: ${maxAttempts === 0 ? '‚àû' : attempts.attemptsLeft}`;

          const now = Date.now();
          if (attempts.cooldownUntil && now < attempts.cooldownUntil) {
            const sec = Math.ceil((attempts.cooldownUntil - now)/1000);
            cooldownDisplay.textContent = `‚è≥ Cooldown: ${sec}s`;
            playerBuzzer.disabled = true;
          } else {
            cooldownDisplay.textContent = '';
            if (buzzer) {
              playerBuzzer.disabled = true;
              playerFeedback.textContent = '‚è≥ Quelqu\'un a buzz√©...';
            } else if (maxAttempts > 0 && attempts.attemptsLeft <= 0) {
              playerBuzzer.disabled = true;
              playerFeedback.textContent = '‚ùå Plus d\'essais';
            } else {
              playerBuzzer.disabled = false;
              playerFeedback.textContent = '';
            }
          }
        }

        playerBuzzer.addEventListener('click', () => {
          if (playerBuzzer.disabled) return;
          const attempts = playerAttempts[clientId] || { attemptsLeft: maxAttempts, cooldownUntil: 0, attemptCount: 0 };
          const now = Date.now();
          if (attempts.cooldownUntil && now < attempts.cooldownUntil) return;
          if (maxAttempts > 0 && attempts.attemptsLeft <= 0) return;
          gameStateRef.update({ buzzer: clientId });
        });

        gameStateRef.child('buzzer').on('value', (snap) => {
          const currentBuzzer = snap.val();
          if (currentBuzzer === clientId) {
            playerBuzzer.disabled = true;
            if (mode === 'kahoot') {
              showChoicePopup();
            } else {
              showAnswerPopup();
            }
          }
        });

        function showAnswerPopup() {
          const popup = document.getElementById('popupAnswer');
          const input = document.getElementById('answerInput');
          const timerSpan = document.getElementById('answerTimer');
          popup.classList.remove('hidden');
          input.value = '';
          input.focus();
          let timeLeft = 10;
          timerSpan.textContent = timeLeft;
          answerStartTime = Date.now();
          if (answerTimerInterval) clearInterval(answerTimerInterval);
          answerTimerInterval = setInterval(() => {
            timeLeft--;
            timerSpan.textContent = timeLeft;
            if (timeLeft <= 0) {
              clearInterval(answerTimerInterval);
              submitAnswer('');
            }
          }, 1000);
        }

        document.getElementById('submitAnswer').onclick = () => {
          const ans = document.getElementById('answerInput').value.trim();
          submitAnswer(ans);
        };

        async function submitAnswer(answer) {
          if (answerTimerInterval) clearInterval(answerTimerInterval);
          document.getElementById('popupAnswer').classList.add('hidden');
          const song = gameSongs[currentSongIndex];
          const correct = song.title;
          const normAnswer = normalize(answer);
          const normCorrect = normalize(correct);
          const isCorrect = normAnswer === normCorrect || normCorrect.includes(normAnswer) || normAnswer.includes(normCorrect);
          const elapsed = roundActive ? Date.now() - roundStartTime : 0;
          let points = 0;
          if (isCorrect) {
            if (mode === 'kahoot') {
              const seconds = elapsed / 1000;
              points = Math.max(20, 100 - Math.floor(seconds * 10));
            } else {
              points = 50;
            }
          } else {
            points = -50;
          }
          await sendResult(points, isCorrect, correct, elapsed);
        }

        function showChoicePopup() {
          const currentSong = gameSongs[currentSongIndex];
          let otherSongs = gameSongs.filter(s => s.title !== currentSong.title);
          while (otherSongs.length < 3) {
            otherSongs = otherSongs.concat(gameSongs);
          }
          shuffleArray(otherSongs);
          const choices = [currentSong, ...otherSongs.slice(0, 3)];
          shuffleArray(choices);
          const grid = document.getElementById('choiceGrid');
          grid.innerHTML = '';
          choices.forEach((song, idx) => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = song.title;
            btn.onclick = () => handleChoice(song, currentSong);
            grid.appendChild(btn);
          });
          document.getElementById('popupChoice').classList.remove('hidden');
          let timeLeft = 5;
          document.getElementById('choiceTimer').textContent = timeLeft;
          if (choiceTimerInterval) clearInterval(choiceTimerInterval);
          choiceTimerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('choiceTimer').textContent = timeLeft;
            if (timeLeft <= 0) {
              clearInterval(choiceTimerInterval);
              handleChoice(null, currentSong);
            }
          }, 1000);
        }

        async function handleChoice(selected, correct) {
          if (choiceTimerInterval) clearInterval(choiceTimerInterval);
          document.getElementById('popupChoice').classList.add('hidden');
          const isCorrect = selected && selected.title === correct.title;
          const elapsed = roundActive ? Date.now() - roundStartTime : 0;
          let points = 0;
          if (isCorrect) {
            const seconds = elapsed / 1000;
            points = Math.max(20, 100 - Math.floor(seconds * 10));
          } else {
            points = -50;
          }
          await sendResult(points, isCorrect, correct.title, elapsed);
        }

        async function sendResult(points, isCorrect, correctTitle, elapsed) {
          scores[clientId] = (scores[clientId] || 0) + points;
          let attempts = playerAttempts[clientId] || { attemptsLeft: maxAttempts, cooldownUntil: 0, attemptCount: 0 };
          if (maxAttempts > 0 && !isCorrect) {
            attempts.attemptsLeft = Math.max(0, attempts.attemptsLeft - 1);
            attempts.attemptCount = (attempts.attemptCount || 0) + 1;
            attempts.cooldownUntil = Date.now() + getCooldown(attempts.attemptCount);
          }
          if (isCorrect) {
            attempts.attemptsLeft = 0;
            attempts.cooldownUntil = 0;
          }
          playerAttempts[clientId] = attempts;
          await gameStateRef.update({
            scores: scores,
            playerAttempts: playerAttempts,
            answerResult: { playerId: clientId, correct: isCorrect, points, correctTitle, playerName: playerName },
            buzzer: null
          });
          const popup = document.getElementById('popupResult');
          document.getElementById('resultTitle').textContent = isCorrect ? 'üéâ Bravo !' : '‚ùå Faux !';
          document.getElementById('resultMessage').innerHTML = isCorrect ? `+${points} points` : `-50 points<br>${correctTitle}`;
          popup.classList.remove('hidden');
          setTimeout(() => popup.classList.add('hidden'), 2000);
        }
      }
    })();
  </script>
</body>
</html>