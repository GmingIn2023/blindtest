<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Buzz & Mix ¬∑ V3</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, sans-serif;
    }
    body {
      background: #0a0c0e;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }
    #app {
      max-width: 650px;
      width: 100%;
      background: #151a1f;
      border-radius: 2rem;
      padding: 1.8rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
    }
    h1, h2 { text-align: center; margin-bottom: 1.5rem; }
    .phase { display: none; }
    .phase.active { display: block; }
    button, input, select {
      background: #1e2a36;
      border: 1px solid #3a4a5a;
      border-radius: 60px;
      padding: 0.8rem 1.2rem;
      color: white;
      width: 100%;
      margin: 0.5rem 0;
      font-size: 1rem;
    }
    button.primary { background: #3b6eff; }
    .room-code {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      background: #0f1a24;
      padding: 1rem;
      border-radius: 1.5rem;
      letter-spacing: 0.3rem;
      margin: 1rem 0;
    }
    .player-list {
      background: #0f1a24;
      border-radius: 1.5rem;
      padding: 1rem;
      margin: 1rem 0;
    }
    .player-tag {
      display: inline-block;
      background: #2a3a4a;
      padding: 0.4rem 1rem;
      border-radius: 60px;
      margin: 0.2rem;
    }
    .buzzer-btn {
      background: radial-gradient(circle at 30% 30%, #ff4d4d, #b30000);
      width: 200px;
      height: 200px;
      border-radius: 50%;
      margin: 2rem auto;
      font-size: 2rem;
      font-weight: bold;
      color: white;
      border: none;
      cursor: pointer;
      display: block;
    }
    .buzzer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e2a36;
      border: 3px solid #ffaa33;
      border-radius: 2rem;
      padding: 2rem;
      width: 90%;
      max-width: 400px;
      z-index: 1000;
      box-shadow: 0 10px 30px black;
    }
    .hidden { display: none !important; }
    .flex { display: flex; gap: 1rem; align-items: center; }
    .timer-big {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ffaa33;
      text-align: center;
      font-family: monospace;
    }
    .notification {
      background: #1e3f5a;
      border-radius: 60px;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      text-align: center;
    }
    .cover-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }
    .cover-img {
      width: 150px;
      height: 150px;
      border-radius: 1rem;
      object-fit: cover;
      transition: filter 0.1s linear;
    }
    .blur-very-high { filter: blur(20px); }
    .blur-high { filter: blur(15px); }
    .blur-medium { filter: blur(10px); }
    .blur-low { filter: blur(5px); }
    .blur-none { filter: blur(0); }
    .cooldown-timer {
      font-size: 1.2rem;
      color: #ffaa33;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- Phase accueil -->
  <div id="phase-home" class="phase active">
    <h1>üéß Test Buzz & Mix</h1>
    <button id="btn-host" class="primary">üéÆ Cr√©er (h√¥te)</button>
    <button id="btn-client">üì± Rejoindre (joueur)</button>
  </div>

  <!-- Phase configuration (h√¥te) -->
  <div id="phase-config" class="phase">
    <h2>Configuration</h2>
    <label>Mode de jeu</label>
    <select id="game-mode">
      <option value="normal">Normal (√©crire titre)</option>
      <option value="kahoot">Kahoot (choix multiple)</option>
    </select>
    <label>Nombre d'essais max par joueur par round (0 = illimit√©)</label>
    <input type="number" id="max-attempts" min="0" max="10" value="3">
    <label>Flouter la cover ?</label>
    <input type="checkbox" id="blur-check" checked>
    <label>Nombre de joueurs (hors h√¥te)</label>
    <input type="number" id="player-count" min="1" max="4" value="1">
    <button id="start-btn" class="primary">Cr√©er la partie</button>
  </div>

  <!-- Lobby h√¥te -->
  <div id="phase-host-lobby" class="phase">
    <h2>Salon h√¥te</h2>
    <div class="room-code" id="roomCodeDisplay"></div>
    <div class="player-list">
      <div>Joueurs connect√©s :</div>
      <div id="connectedPlayersList"></div>
    </div>
    <button id="startGameBtn" disabled>‚è≥ En attente...</button>
  </div>

  <!-- Lobby joueur -->
  <div id="phase-player-lobby" class="phase">
    <h2>Rejoindre</h2>
    <input type="text" id="joinCode" placeholder="Code">
    <input type="text" id="joinName" placeholder="Ton nom" value="Joueur">
    <button id="joinBtn">Rejoindre</button>
    <div id="playerLobbyStatus"></div>
  </div>

  <!-- Jeu h√¥te -->
  <div id="phase-host-game" class="phase">
    <h2>H√¥te</h2>
    <div id="hostSongInfo" style="font-size:1.2rem; margin:1rem 0;"></div>
    <button id="hostPlay" class="primary">‚ñ∂Ô∏è Jouer l'extrait</button>
    <div class="timer-big" id="hostTimer">00:00.0</div>
    <div class="cover-container">
      <img id="hostCover" class="cover-img blur-none" src="" alt="cover">
    </div>
    <div id="hostNotification" class="notification"></div>
    <div id="hostScoreboard" style="background:#0f1a24; border-radius:1.5rem; padding:1rem; margin:1rem 0;"></div>
    <button id="hostNext" disabled>‚è© Chanson suivante</button>
  </div>

  <!-- Jeu joueur -->
  <div id="phase-player-game" class="phase">
    <h2 id="playerNameHeader">Joueur</h2>
    <div id="playerSongInfo" style="text-align:center; margin:1rem 0;"></div>
    <div class="timer-big" id="playerTimer">00:00.0</div>
    <div id="playerScore" style="font-size:1.5rem; text-align:center; color:#d4ffb0;">0 pts</div>
    <div id="playerAttempts" style="text-align:center;">Essais restants: ‚àû</div>
    <div id="cooldownDisplay" class="cooldown-timer" style="text-align:center;"></div>
    <button class="buzzer-btn" id="playerBuzzer">JE SAIS !</button>
    <div id="playerFeedback" style="text-align:center;"></div>
  </div>

  <!-- Popup r√©ponse √©crite (mode normal) -->
  <div id="popupAnswer" class="popup hidden">
    <h3>‚úèÔ∏è Tape le titre</h3>
    <input type="text" id="answerInput" placeholder="Titre">
    <div class="flex" style="margin-top:1rem;">
      <button id="submitAnswer">Valider</button>
      <span id="timer" class="timer-big" style="font-size:1.8rem;">10</span>
    </div>
  </div>

  <!-- Popup choix multiple (mode Kahoot) -->
  <div id="popupChoice" class="popup hidden">
    <h3>üéØ Choisis la chanson</h3>
    <div id="choiceGrid" class="choice-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:0.5rem;"></div>
    <div id="choiceTimer" class="timer-big" style="margin-top:1rem;">5</div>
  </div>

  <!-- Popup de r√©sultat (Bravo / Faux) -->
  <div id="popupResult" class="popup hidden">
    <h3 id="resultTitle"></h3>
    <p id="resultMessage"></p>
    <button id="closeResult">OK</button>
  </div>

  <canvas id="confetti" style="display:none;"></canvas>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
  (function(){
    "use strict";
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBOEU9kg6YuXllGEGS9iod_SsBRu9NOPro",
      authDomain: "blind-test-kahoot.firebaseapp.com",
      databaseURL: "https://blind-test-kahoot-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "blind-test-kahoot",
      storageBucket: "blind-test-kahoot.firebasestorage.app",
      messagingSenderId: "798773649205",
      appId: "1:798773649205:web:de5dd5cbce41ea2ec5b67c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Liste de chansons avec artworks (via placeholder pour √©viter CORS)
    const songList = [
      { title: "Billie Jean", artist: "Michael Jackson", artwork: "https://via.placeholder.com/150/1e2a36/ffffff?text=üéµ" },
      { title: "Shape of You", artist: "Ed Sheeran", artwork: "https://via.placeholder.com/150/2a3b4c/ffffff?text=üéµ" },
      { title: "Uptown Funk", artist: "Bruno Mars", artwork: "https://via.placeholder.com/150/3c4d5e/ffffff?text=üéµ" },
      { title: "Blinding Lights", artist: "The Weeknd", artwork: "https://via.placeholder.com/150/4e5f6g/ffffff?text=üéµ" },
      { title: "Despacito", artist: "Luis Fonsi", artwork: "https://via.placeholder.com/150/5f6g7h/ffffff?text=üéµ" }
    ];

    // √âtat global
    const state = {
      roomCode: null,
      isHost: false,
      clientId: null,
      playerName: '',
      players: [],
      gameSongs: songList,
      currentSongIndex: 0,
      mode: 'normal',
      maxAttempts: 3,
      blurEnabled: false,
      scores: {},
      playerAttempts: {}, // { id: { attemptsLeft, cooldownUntil, attemptCount } }
      buzzerLocked: false,
      roundStartTime: 0,
      roundTimerInterval: null,
      roundActive: false,
    };

    // DOM helpers
    const $ = id => document.getElementById(id);
    const phases = {
      home: $('phase-home'),
      config: $('phase-config'),
      hostLobby: $('phase-host-lobby'),
      playerLobby: $('phase-player-lobby'),
      hostGame: $('phase-host-game'),
      playerGame: $('phase-player-game'),
    };
    function showPhase(name) {
      Object.values(phases).forEach(p => p.classList.remove('active'));
      phases[name].classList.add('active');
    }

    function generateCode() {
      return Math.random().toString(36).substring(2,6).toUpperCase();
    }

    // Normalisation pour tol√©rance
    function normalize(str) {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/[^a-z0-9]/g, "");
    }

    // Cooldown exponentiel: 3s, 5s, 7s, ...
    function getCooldown(attemptCount) {
      return 3000 + (attemptCount - 1) * 2000;
    }

    // Formatage du timer (minutes:secondes.dixi√®mes)
    function formatTimer(ms) {
      let seconds = Math.floor(ms / 1000);
      let tenth = Math.floor((ms % 1000) / 100);
      let minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}.${tenth}`;
    }

    // === Accueil ===
    $('btn-host').onclick = () => showPhase('config');
    $('btn-client').onclick = () => showPhase('playerLobby');

    // === Cr√©ation partie (h√¥te) ===
    $('start-btn').onclick = async () => {
      const mode = $('game-mode').value;
      const maxAttempts = parseInt($('max-attempts').value, 10) || 0;
      const blurEnabled = $('blur-check').checked;
      const playerCount = parseInt($('player-count').value, 10) || 1;
      state.mode = mode;
      state.maxAttempts = maxAttempts;
      state.blurEnabled = blurEnabled;
      state.roomCode = generateCode();
      state.isHost = true;
      state.clientId = 'host';
      try {
        const roomRef = db.ref('rooms/' + state.roomCode);
        await roomRef.set({
          players: {},
          gameState: {
            currentSongIndex: 0,
            songs: state.gameSongs,
            scores: {},
            playerAttempts: {},
            buzzer: null,
            mode: state.mode,
            maxAttempts: state.maxAttempts,
            blurEnabled: state.blurEnabled,
            roundStartTime: 0,
            roundActive: false,
          },
          status: 'lobby',
          createdAt: Date.now(),
        });
        // √âcouter les joueurs
        roomRef.child('players').on('value', (snap) => {
          const players = snap.val() || {};
          state.players = Object.entries(players).map(([id, p]) => ({ id, ...p }));
          updateHostLobby();
        });
        // √âcouter gameState
        roomRef.child('gameState').on('value', (snap) => {
          const gs = snap.val() || {};
          state.currentSongIndex = gs.currentSongIndex || 0;
          state.gameSongs = gs.songs || state.gameSongs;
          state.scores = gs.scores || {};
          state.playerAttempts = gs.playerAttempts || {};
          state.buzzerLocked = !!gs.buzzer;
          state.mode = gs.mode || 'normal';
          state.maxAttempts = gs.maxAttempts || 0;
          state.blurEnabled = gs.blurEnabled || false;
          state.roundStartTime = gs.roundStartTime || 0;
          state.roundActive = gs.roundActive || false;
          if (state.isHost) updateHostGame();
          if (!state.isHost) updatePlayerGame(gs);
        });
        $('roomCodeDisplay').textContent = state.roomCode;
        showPhase('hostLobby');
      } catch(e) { alert('Erreur cr√©ation: '+e.message); }
    };

    function updateHostLobby() {
      const list = $('connectedPlayersList');
      list.innerHTML = state.players.map(p => `<span class="player-tag">${p.name}</span>`).join('');
      const btn = $('startGameBtn');
      const needed = parseInt($('player-count').value);
      if (state.players.length >= needed) {
        btn.disabled = false;
        btn.textContent = 'D√©marrer le jeu';
        btn.onclick = async () => {
          const roomRef = db.ref('rooms/' + state.roomCode);
          await roomRef.update({ status: 'game' });
          showPhase('hostGame');
          updateHostGame();
        };
      } else {
        btn.disabled = true;
        btn.textContent = `En attente de ${needed - state.players.length} joueur(s)`;
      }
    }

    // === Rejoindre (joueur) ===
    $('joinBtn').onclick = async () => {
      const code = $('joinCode').value.trim().toUpperCase();
      const name = $('joinName').value.trim() || 'Joueur';
      if (!code) return alert('Entre un code');
      state.roomCode = code;
      state.playerName = name;
      state.clientId = 'player_' + Date.now() + '_' + Math.random().toString(36).substring(2);
      try {
        const roomRef = db.ref('rooms/' + code);
        const snap = await roomRef.once('value');
        if (!snap.exists()) return alert('Partie introuvable');
        const data = snap.val();
        if (data.status !== 'lobby') return alert('Partie d√©j√† commenc√©e');
        await roomRef.child('players/' + state.clientId).set({ name, joinedAt: Date.now() });
        // √âcouter les changements
        roomRef.child('status').on('value', (snap) => {
          if (snap.val() === 'game') {
            showPhase('playerGame');
            $('playerNameHeader').textContent = state.playerName;
          }
        });
        roomRef.child('gameState').on('value', (snap) => {
          const gs = snap.val() || {};
          state.currentSongIndex = gs.currentSongIndex || 0;
          state.gameSongs = gs.songs || [];
          state.scores = gs.scores || {};
          state.playerAttempts = gs.playerAttempts || {};
          state.mode = gs.mode || 'normal';
          state.maxAttempts = gs.maxAttempts || 0;
          state.blurEnabled = gs.blurEnabled || false;
          state.roundStartTime = gs.roundStartTime || 0;
          state.roundActive = gs.roundActive || false;
          state.buzzerLocked = !!gs.buzzer;
          updatePlayerGame(gs);
        });
        $('playerLobbyStatus').innerHTML = 'Connect√©, attente du d√©but...';
      } catch(e) { alert('Erreur connexion: '+e.message); }
    };

    // === Mise √† jour interface joueur ===
    function updatePlayerGame(gs) {
      const song = state.gameSongs[state.currentSongIndex];
      $('playerSongInfo').textContent = `Chanson ${state.currentSongIndex+1} / ${state.gameSongs.length}`;
      $('playerScore').textContent = (state.scores[state.clientId] || 0) + ' pts';

      // Gestion des essais et cooldown
      const attemptsData = state.playerAttempts[state.clientId] || { attemptsLeft: state.maxAttempts, cooldownUntil: 0, attemptCount: 0 };
      let attemptsText = state.maxAttempts === 0 ? '‚àû' : attemptsData.attemptsLeft;
      $('playerAttempts').innerHTML = `Essais restants: ${attemptsText}`;

      const now = Date.now();
      if (attemptsData.cooldownUntil && now < attemptsData.cooldownUntil) {
        const remaining = Math.ceil((attemptsData.cooldownUntil - now)/1000);
        $('cooldownDisplay').innerHTML = `‚è≥ Cooldown: ${remaining}s`;
        // Mise √† jour dynamique (toutes les secondes)
        if (!window.cooldownInterval) {
          window.cooldownInterval = setInterval(() => {
            const newNow = Date.now();
            if (attemptsData.cooldownUntil && newNow < attemptsData.cooldownUntil) {
              const rem = Math.ceil((attemptsData.cooldownUntil - newNow)/1000);
              $('cooldownDisplay').innerHTML = `‚è≥ Cooldown: ${rem}s`;
            } else {
              $('cooldownDisplay').innerHTML = '';
              clearInterval(window.cooldownInterval);
              window.cooldownInterval = null;
            }
          }, 1000);
        }
      } else {
        $('cooldownDisplay').innerHTML = '';
        if (window.cooldownInterval) {
          clearInterval(window.cooldownInterval);
          window.cooldownInterval = null;
        }
      }

      // Gestion du buzzer
      if (gs.buzzer === state.clientId) {
        $('playerBuzzer').disabled = true;
        // Afficher la popup selon le mode
        if (state.mode === 'kahoot') showChoicePopup();
        else showAnswerPopup();
      } else if (gs.buzzer) {
        $('playerBuzzer').disabled = true;
        $('playerFeedback').innerHTML = '‚è≥ Quelqu\'un a buzz√©...';
      } else {
        // Peut-il buzzer ?
        if (state.maxAttempts > 0 && attemptsData.attemptsLeft <= 0) {
          $('playerBuzzer').disabled = true;
          $('playerFeedback').innerHTML = '‚ùå Plus d\'essais';
        } else if (attemptsData.cooldownUntil && now < attemptsData.cooldownUntil) {
          $('playerBuzzer').disabled = true;
        } else {
          $('playerBuzzer').disabled = false;
          $('playerFeedback').innerHTML = '';
        }
      }

      // Timer synchro
      if (state.roundActive && state.roundStartTime > 0) {
        const elapsed = Date.now() - state.roundStartTime;
        $('playerTimer').textContent = formatTimer(elapsed);
      } else {
        $('playerTimer').textContent = '00:00.0';
      }
    }

    // === Bouton Je sais (joueur) ===
    $('playerBuzzer').onclick = async () => {
      if ($('playerBuzzer').disabled) return;
      // V√©rifier cooldown et essais
      const attemptsData = state.playerAttempts[state.clientId] || { attemptsLeft: state.maxAttempts, cooldownUntil: 0, attemptCount: 0 };
      const now = Date.now();
      if (state.maxAttempts > 0 && attemptsData.attemptsLeft <= 0) {
        $('playerFeedback').innerHTML = '‚ùå Plus d\'essais';
        return;
      }
      if (attemptsData.cooldownUntil && now < attemptsData.cooldownUntil) return;
      $('playerBuzzer').disabled = true;
      const roomRef = db.ref('rooms/' + state.roomCode);
      await roomRef.child('gameState/buzzer').set(state.clientId);
    };

    // === Popup r√©ponse √©crite ===
    let answerTimer = null;
    function showAnswerPopup() {
      $('popupAnswer').classList.remove('hidden');
      $('answerInput').value = '';
      $('answerInput').focus();
      let timeLeft = 10;
      $('timer').textContent = timeLeft;
      if (answerTimer) clearInterval(answerTimer);
      answerTimer = setInterval(() => {
        timeLeft--;
        $('timer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(answerTimer);
          submitAnswer('');
        }
      }, 1000);
    }

    $('submitAnswer').onclick = () => {
      const ans = $('answerInput').value.trim();
      submitAnswer(ans);
    };

    async function submitAnswer(answer) {
      if (answerTimer) clearInterval(answerTimer);
      $('popupAnswer').classList.add('hidden');
      const song = state.gameSongs[state.currentSongIndex];
      const correct = song.title;
      const normAnswer = normalize(answer);
      const normCorrect = normalize(correct);
      const isCorrect = normAnswer === normCorrect || normCorrect.includes(normAnswer) || normAnswer.includes(normCorrect);
      const elapsed = state.roundActive ? Date.now() - state.roundStartTime : 0;
      let points = 0;
      if (isCorrect) {
        if (state.mode === 'kahoot') {
          // points bas√©s sur le temps (max 100, perd 5 par seconde)
          const seconds = elapsed / 1000;
          points = Math.max(20, 100 - Math.floor(seconds * 5));
        } else {
          points = 50;
        }
      } else {
        points = -50;
      }
      await sendResult(points, isCorrect, correct, elapsed, isCorrect);
    }

    // === Popup choix multiple ===
    let choiceTimer = null;
    function showChoicePopup() {
      const currentSong = state.gameSongs[state.currentSongIndex];
      // G√©n√©rer 4 propositions (dont la bonne)
      let otherSongs = songList.filter(s => s.title !== currentSong.title);
      while (otherSongs.length < 3) otherSongs = otherSongs.concat(songList);
      shuffleArray(otherSongs);
      const choices = [currentSong, ...otherSongs.slice(0, 3)];
      shuffleArray(choices);
      const grid = $('choiceGrid');
      grid.innerHTML = '';
      choices.forEach((song, idx) => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = song.title;
        btn.onclick = () => handleChoice(song, currentSong);
        grid.appendChild(btn);
      });
      $('popupChoice').classList.remove('hidden');
      let timeLeft = 5;
      $('choiceTimer').textContent = timeLeft;
      if (choiceTimer) clearInterval(choiceTimer);
      choiceTimer = setInterval(() => {
        timeLeft--;
        $('choiceTimer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(choiceTimer);
          handleChoice(null, currentSong);
        }
      }, 1000);
    }

    async function handleChoice(selected, correct) {
      if (choiceTimer) clearInterval(choiceTimer);
      $('popupChoice').classList.add('hidden');
      const isCorrect = selected && selected.title === correct.title;
      const elapsed = state.roundActive ? Date.now() - state.roundStartTime : 0;
      let points = 0;
      if (isCorrect) {
        const seconds = elapsed / 1000;
        points = Math.max(20, 100 - Math.floor(seconds * 5));
      } else {
        points = -50;
      }
      await sendResult(points, isCorrect, correct.title, elapsed, isCorrect);
    }

    // === Fonction commune pour envoyer le r√©sultat ===
    async function sendResult(points, success, correctTitle, elapsed, isCorrect) {
      const roomRef = db.ref('rooms/' + state.roomCode);
      const scores = state.scores;
      scores[state.clientId] = (scores[state.clientId] || 0) + points;

      // Mise √† jour des tentatives
      let attemptsData = state.playerAttempts[state.clientId] || { attemptsLeft: state.maxAttempts, cooldownUntil: 0, attemptCount: 0 };
      if (state.maxAttempts > 0 && !isCorrect) {
        attemptsData.attemptsLeft = Math.max(0, attemptsData.attemptsLeft - 1);
        attemptsData.attemptCount = (attemptsData.attemptCount || 0) + 1;
        const cooldown = getCooldown(attemptsData.attemptCount);
        attemptsData.cooldownUntil = Date.now() + cooldown;
      }
      if (isCorrect) {
        // Succ√®s: on bloque les essais pour ce round (plus de buzz)
        attemptsData.attemptsLeft = 0;
        attemptsData.cooldownUntil = 0;
      }
      state.playerAttempts[state.clientId] = attemptsData;

      await roomRef.child('gameState').update({
        scores: scores,
        playerAttempts: state.playerAttempts,
        answerResult: { playerId: state.clientId, correct: isCorrect, points, correctTitle, playerName: state.playerName },
        buzzer: null,
      });

      // Afficher popup r√©sultat
      $('popupResult').classList.remove('hidden');
      $('resultTitle').textContent = isCorrect ? 'üéâ Bravo !' : '‚ùå Faux !';
      $('resultMessage').innerHTML = isCorrect ? `Tu as gagn√© ${points} points !` : `Mauvaise r√©ponse... (c'√©tait ${correctTitle})<br>${points} points`;
    }

    $('closeResult').onclick = () => {
      $('popupResult').classList.add('hidden');
    };

    // === Jeu h√¥te ===
    let hostTimerInterval = null;
    function updateHostGame() {
      const song = state.gameSongs[state.currentSongIndex];
      $('hostSongInfo').textContent = `Chanson ${state.currentSongIndex+1} / ${state.gameSongs.length} - ${song.title}`;
      $('hostCover').src = song.artwork;
      if (!state.blurEnabled) {
        $('hostCover').className = 'cover-img blur-none';
      }

      let scoresHtml = '<strong>Scores:</strong><br>';
      state.players.forEach(p => {
        scoresHtml += `<div>${p.name}: ${state.scores[p.id] || 0} pts</div>`;
      });
      $('hostScoreboard').innerHTML = scoresHtml;
      $('hostNotification').innerHTML = state.buzzerLocked ? 'üîî Buzz en cours...' : '';

      // Timer
      if (state.roundActive && state.roundStartTime > 0) {
        const elapsed = Date.now() - state.roundStartTime;
        $('hostTimer').textContent = formatTimer(elapsed);
      } else {
        $('hostTimer').textContent = '00:00.0';
      }

      // √âcouter les r√©sultats
      const answerResultRef = db.ref('rooms/' + state.roomCode + '/gameState/answerResult');
      answerResultRef.on('value', (snap) => {
        const res = snap.val();
        if (res) {
          const player = state.players.find(p => p.id === res.playerId);
          if (player) {
            let msg = `${player.name}: `;
            if (res.correct) msg += `‚úÖ +${res.points}`;
            else msg += `‚ùå ${res.points}`;
            $('hostNotification').innerHTML = msg;
            setTimeout(() => $('hostNotification').innerHTML = '', 3000);
          }
          answerResultRef.remove();
        }
      });

      // Activer le bouton suivant si pas de buzzer
      $('hostNext').disabled = state.buzzerLocked;
    }

    $('hostPlay').onclick = async () => {
      if (state.roundActive) return; // d√©j√† lanc√©
      const roomRef = db.ref('rooms/' + state.roomCode);
      const startTime = Date.now();
      await roomRef.child('gameState').update({
        roundStartTime: startTime,
        roundActive: true,
        buzzer: null,
      });

      // Gestion du flou progressif
      if (state.blurEnabled) {
        $('hostCover').className = 'cover-img blur-very-high';
        let level = 5;
        const interval = setInterval(() => {
          level--;
          if (level === 4) $('hostCover').className = 'cover-img blur-high';
          else if (level === 3) $('hostCover').className = 'cover-img blur-medium';
          else if (level === 2) $('hostCover').className = 'cover-img blur-low';
          else if (level === 1) $('hostCover').className = 'cover-img blur-none';
          if (level <= 0) clearInterval(interval);
        }, 1000);
      }
    };

    $('hostNext').onclick = async () => {
      if (state.currentSongIndex + 1 < state.gameSongs.length) {
        const next = state.currentSongIndex + 1;
        const roomRef = db.ref('rooms/' + state.roomCode);
        await roomRef.child('gameState').update({
          currentSongIndex: next,
          roundActive: false,
          buzzer: null,
          playerAttempts: {}, // r√©initialiser les essais pour le nouveau round
        });
      } else {
        alert('Fin du jeu');
      }
    };

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // Nettoyage
    window.onunload = () => {
      if (state.roomCode) {
        db.ref('rooms/' + state.roomCode).remove();
      }
    };
  })();
</script>
</body>
</html>