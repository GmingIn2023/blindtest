
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blind Test ¬∑ Buzz & Mix</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, sans-serif;
    }
    body {
      background: #0a0c0e;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }
    #app {
      max-width: 650px;
      width: 100%;
      background: #151a1f;
      border-radius: 2rem;
      padding: 1.8rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
    }
    h1, h2 { text-align: center; margin-bottom: 1.5rem; }
    .phase { display: none; }
    .phase.active { display: block; }
    button, input, select {
      background: #1e2a36;
      border: 1px solid #3a4a5a;
      border-radius: 60px;
      padding: 0.8rem 1.2rem;
      color: white;
      width: 100%;
      margin: 0.5rem 0;
      font-size: 1rem;
    }
    button.primary { background: #3b6eff; }
    .room-code {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      background: #0f1a24;
      padding: 1rem;
      border-radius: 1.5rem;
      letter-spacing: 0.3rem;
      margin: 1rem 0;
    }
    .player-list {
      background: #0f1a24;
      border-radius: 1.5rem;
      padding: 1rem;
      margin: 1rem 0;
    }
    .player-tag {
      display: inline-block;
      background: #2a3a4a;
      padding: 0.4rem 1rem;
      border-radius: 60px;
      margin: 0.2rem;
    }
    .buzzer-btn {
      background: radial-gradient(circle at 30% 30%, #ff4d4d, #b30000);
      width: 200px;
      height: 200px;
      border-radius: 50%;
      margin: 2rem auto;
      font-size: 2rem;
      font-weight: bold;
      color: white;
      border: none;
      cursor: pointer;
      display: block;
    }
    .buzzer-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1e2a36;
      border: 3px solid #ffaa33;
      border-radius: 2rem;
      padding: 2rem;
      width: 90%;
      max-width: 400px;
      z-index: 1000;
      box-shadow: 0 10px 30px black;
    }
    .hidden { display: none !important; }
    .flex { display: flex; gap: 1rem; align-items: center; }
    .choice-grid {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 0.8rem;
      margin-top: 1rem;
    }
    .choice-btn {
      background: #2a3a4a;
      border: 2px solid #5e9eff;
      border-radius: 1rem;
      padding: 0.8rem;
      cursor: pointer;
      text-align: center;
    }
    .choice-btn:hover {
      background: #3b6eff;
    }
    .choice-btn.selected {
      background: #3b6eff;
      border-color: white;
    }
    .timer {
      font-size: 2rem;
      font-weight: bold;
      color: #ffaa33;
      text-align: center;
    }
    .notification {
      background: #1e3f5a;
      border-radius: 60px;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      text-align: center;
    }
    .cover-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }
    .cover-img {
      width: 150px;
      height: 150px;
      border-radius: 1rem;
      object-fit: cover;
      transition: filter 0.1s linear;
    }
    .blur-very-high { filter: blur(20px); }
    .blur-high { filter: blur(15px); }
    .blur-medium { filter: blur(10px); }
    .blur-low { filter: blur(5px); }
    .blur-none { filter: blur(0); }
  </style>
</head>
<body>
<div id="app">
  <!-- Phase accueil -->
  <div id="phase-home" class="phase active">
    <h1>üéß Blind Test ¬∑ Buzz & Mix</h1>
    <button id="btn-host" class="primary">üéÆ Cr√©er (h√¥te)</button>
    <button id="btn-client">üì± Rejoindre (joueur)</button>
  </div>

  <!-- Phase configuration (h√¥te) -->
  <div id="phase-config" class="phase">
    <h2>Configuration</h2>
    <label>Mode de jeu</label>
    <select id="game-mode">
      <option value="normal">Normal (√©crire titre)</option>
      <option value="expert">Expert (√©crire, tol√©rance)</option>
      <option value="kahoot">Kahoot (choix multiple)</option>
    </select>
    <label>Nombre d'essais max par joueur par round (0 = illimit√©)</label>
    <input type="number" id="max-attempts" min="0" max="10" value="3">
    <label>Flouter la cover ?</label>
    <input type="checkbox" id="blur-check"> Oui, flou progressif
    <label>Nombre de joueurs (hors h√¥te)</label>
    <input type="number" id="player-count" min="1" max="4" value="1">
    <button id="start-btn" class="primary">Cr√©er la partie</button>
  </div>

  <!-- Lobby h√¥te -->
  <div id="phase-host-lobby" class="phase">
    <h2>Salon h√¥te</h2>
    <div class="room-code" id="roomCodeDisplay"></div>
    <div class="player-list">
      <div>Joueurs connect√©s :</div>
      <div id="connectedPlayersList"></div>
    </div>
    <button id="startGameBtn" disabled>‚è≥ En attente...</button>
  </div>

  <!-- Lobby joueur -->
  <div id="phase-player-lobby" class="phase">
    <h2>Rejoindre</h2>
    <input type="text" id="joinCode" placeholder="Code">
    <input type="text" id="joinName" placeholder="Ton nom" value="Joueur">
    <button id="joinBtn">Rejoindre</button>
    <div id="playerLobbyStatus"></div>
  </div>

  <!-- Jeu h√¥te -->
  <div id="phase-host-game" class="phase">
    <h2>H√¥te - jeu</h2>
    <div id="hostSongInfo" style="font-size:1.2rem; margin:1rem 0;"></div>
    <button id="hostPlay">‚ñ∂Ô∏è Jouer l'extrait</button>
    <div class="cover-container">
      <img id="hostCover" class="cover-img blur-none" src="" alt="cover">
    </div>
    <div id="hostNotification" class="notification"></div>
    <div id="hostScoreboard" style="background:#0f1a24; border-radius:1.5rem; padding:1rem; margin:1rem 0;"></div>
    <button id="hostNext" disabled>‚è© Chanson suivante</button>
  </div>

  <!-- Jeu joueur -->
  <div id="phase-player-game" class="phase">
    <h2>Joueur</h2>
    <div id="playerSongInfo" style="text-align:center; margin:1rem 0;"></div>
    <div id="playerScore" style="font-size:1.5rem; text-align:center; color:#d4ffb0;">0 pts</div>
    <div id="playerAttempts" style="text-align:center;">Essais restants: ‚àû</div>
    <button class="buzzer-btn" id="playerBuzzer">JE SAIS !</button>
    <div id="playerFeedback" style="text-align:center;"></div>
  </div>

  <!-- Popup r√©ponse √©crite simple -->
  <div id="popupAnswer" class="popup hidden">
    <h3>‚úèÔ∏è Tape le titre</h3>
    <input type="text" id="answerInput" placeholder="Titre">
    <div class="flex" style="margin-top:1rem;">
      <button id="submitAnswer">Valider</button>
      <span id="timer" class="timer">10</span>
    </div>
  </div>

  <!-- Popup r√©ponse mix (deux titres) -->
  <div id="popupMix" class="popup hidden">
    <h3>üîÄ Deux chansons</h3>
    <p>√âcris les deux titres :</p>
    <input type="text" id="mixInput1" placeholder="Premier titre">
    <input type="text" id="mixInput2" placeholder="Deuxi√®me titre">
    <div class="flex" style="margin-top:1rem;">
      <button id="submitMix">Valider</button>
      <span id="mixTimer" class="timer">15</span>
    </div>
  </div>

  <!-- Popup choix multiple (mode Kahoot) -->
  <div id="popupChoice" class="popup hidden">
    <h3>üéØ Choisis la chanson</h3>
    <div id="choiceGrid" class="choice-grid"></div>
    <div id="choiceTimer" class="timer" style="margin-top:1rem;">5</div>
  </div>

  <!-- Popup choix multiple pour mix (deux choix) -->
  <div id="popupChoiceMix" class="popup hidden">
    <h3>üîÄ Choisis les deux chansons</h3>
    <div id="choiceMixGrid" class="choice-grid"></div>
    <div id="choiceMixTimer" class="timer" style="margin-top:1rem;">15</div>
  </div>

  <canvas id="confetti" style="display:none;"></canvas>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
  (function(){
    "use strict";
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBOEU9kg6YuXllGEGS9iod_SsBRu9NOPro",
      authDomain: "blind-test-kahoot.firebaseapp.com",
      databaseURL: "https://blind-test-kahoot-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "blind-test-kahoot",
      storageBucket: "blind-test-kahoot.firebasestorage.app",
      messagingSenderId: "798773649205",
      appId: "1:798773649205:web:de5dd5cbce41ea2ec5b67c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Liste de chansons avec extraits SoundHelix (libres de droits) et covers placeholder
    const songList = [
      { title: "Billie Jean", artist: "Michael Jackson", preview: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", artwork: "https://via.placeholder.com/150/1e2a36/5e9eff?text=üéµ" },
      { title: "Shape of You", artist: "Ed Sheeran", preview: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3", artwork: "https://via.placeholder.com/150/1e2a36/5e9eff?text=üéµ" },
      { title: "Uptown Funk", artist: "Bruno Mars", preview: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3", artwork: "https://via.placeholder.com/150/1e2a36/5e9eff?text=üéµ" },
      { title: "Blinding Lights", artist: "The Weeknd", preview: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3", artwork: "https://via.placeholder.com/150/1e2a36/5e9eff?text=üéµ" },
      { title: "Despacito", artist: "Luis Fonsi", preview: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3", artwork: "https://via.placeholder.com/150/1e2a36/5e9eff?text=üéµ" },
      { title: "Rolling in the Deep", artist: "Adele", preview: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3", artwork: "https://via.placeholder.com/150/1e2a36/5e9eff?text=üéµ" },
      { title: "Happy", artist: "Pharrell Williams", preview: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3", artwork: "https://via.placeholder.com/150/1e2a36/5e9eff?text=üéµ" },
      { title: "Shake It Off", artist: "Taylor Swift", preview: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3", artwork: "https://via.placeholder.com/150/1e2a36/5e9eff?text=üéµ" }
    ];

    // √âtat global
    const state = {
      roomCode: null,
      isHost: false,
      clientId: null,
      playerName: '',
      players: [],
      gameSongs: songList.slice(0, 5),
      currentSongIndex: 0,
      currentSong: null,
      mixed: false,
      mixedSongs: [],
      mode: 'normal',
      maxAttempts: 3,
      blurEnabled: false,
      scores: {},
      playerAttempts: {}, // stock√© dans Firebase pour chaque round
      buzzerLocked: false,
    };

    // DOM helpers
    const $ = id => document.getElementById(id);
    const phases = {
      home: $('phase-home'),
      config: $('phase-config'),
      hostLobby: $('phase-host-lobby'),
      playerLobby: $('phase-player-lobby'),
      hostGame: $('phase-host-game'),
      playerGame: $('phase-player-game'),
    };
    function showPhase(name) {
      Object.values(phases).forEach(p => p.classList.remove('active'));
      phases[name].classList.add('active');
    }

    function generateCode() {
      return Math.random().toString(36).substring(2,6).toUpperCase();
    }

    // Normalisation pour tol√©rance (enl√®ve accents, caract√®res sp√©ciaux)
    function normalize(str) {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/[^a-z0-9]/g, "");
    }

    // Cooldown exponentiel (3s,5s,7s,...)
    function getCooldown(attemptNumber) {
      return 3000 + (attemptNumber - 1) * 2000;
    }

    // === Accueil ===
    $('btn-host').onclick = () => showPhase('config');
    $('btn-client').onclick = () => showPhase('playerLobby');

    // === Cr√©ation partie (h√¥te) ===
    $('start-btn').onclick = async () => {
      const mode = $('game-mode').value;
      const maxAttempts = parseInt($('max-attempts').value, 10) || 0;
      const blurEnabled = $('blur-check').checked;
      const playerCount = parseInt($('player-count').value, 10) || 1;
      state.mode = mode;
      state.maxAttempts = maxAttempts;
      state.blurEnabled = blurEnabled;
      state.roomCode = generateCode();
      state.isHost = true;
      state.clientId = 'host';
      try {
        const roomRef = db.ref('rooms/' + state.roomCode);
        await roomRef.set({
          players: {},
          gameState: {
            currentSongIndex: 0,
            songs: state.gameSongs,
            scores: {},
            playerAttempts: {}, // r√©initialis√© √† chaque round
            buzzer: null,
            mixed: false,
            mixedSongs: [],
            mode: state.mode,
            maxAttempts: state.maxAttempts,
            blurEnabled: state.blurEnabled,
          },
          status: 'lobby',
          createdAt: Date.now(),
        });
        // √âcouter les joueurs
        roomRef.child('players').on('value', (snap) => {
          const players = snap.val() || {};
          state.players = Object.entries(players).map(([id, p]) => ({ id, ...p }));
          updateHostLobby();
        });
        // √âcouter gameState
        roomRef.child('gameState').on('value', (snap) => {
          const gs = snap.val() || {};
          state.currentSongIndex = gs.currentSongIndex || 0;
          state.gameSongs = gs.songs || state.gameSongs;
          state.scores = gs.scores || {};
          state.playerAttempts = gs.playerAttempts || {};
          state.mixed = gs.mixed || false;
          state.mixedSongs = gs.mixedSongs || [];
          state.buzzerLocked = !!gs.buzzer;
          state.mode = gs.mode || 'normal';
          state.maxAttempts = gs.maxAttempts || 0;
          state.blurEnabled = gs.blurEnabled || false;
          if (state.isHost) updateHostGame();
        });
        $('roomCodeDisplay').textContent = state.roomCode;
        showPhase('hostLobby');
      } catch(e) { alert('Erreur cr√©ation: '+e.message); }
    };

    function updateHostLobby() {
      const list = $('connectedPlayersList');
      list.innerHTML = state.players.map(p => `<span class="player-tag">${p.name}</span>`).join('');
      const btn = $('startGameBtn');
      const needed = parseInt($('player-count').value);
      if (state.players.length >= needed) {
        btn.disabled = false;
        btn.textContent = 'D√©marrer le jeu';
        btn.onclick = async () => {
          const roomRef = db.ref('rooms/' + state.roomCode);
          // R√©initialiser les tentatives pour le premier round
          await roomRef.child('gameState/playerAttempts').set({});
          await roomRef.update({ status: 'game' });
          showPhase('hostGame');
          updateHostGame();
        };
      } else {
        btn.disabled = true;
        btn.textContent = `En attente de ${needed - state.players.length} joueur(s)`;
      }
    }

    // === Rejoindre (joueur) ===
    $('joinBtn').onclick = async () => {
      const code = $('joinCode').value.trim().toUpperCase();
      const name = $('joinName').value.trim() || 'Joueur';
      if (!code) return alert('Entre un code');
      state.roomCode = code;
      state.playerName = name;
      state.clientId = 'player_' + Date.now() + '_' + Math.random().toString(36).substring(2);
      try {
        const roomRef = db.ref('rooms/' + code);
        const snap = await roomRef.once('value');
        if (!snap.exists()) return alert('Partie introuvable');
        const data = snap.val();
        if (data.status !== 'lobby') return alert('Partie d√©j√† commenc√©e');
        await roomRef.child('players/' + state.clientId).set({ name, joinedAt: Date.now() });
        // √âcouter les changements
        roomRef.child('status').on('value', (snap) => {
          if (snap.val() === 'game') {
            showPhase('playerGame');
            initPlayerGame();
          }
        });
        roomRef.child('gameState').on('value', (snap) => {
          const gs = snap.val() || {};
          state.currentSongIndex = gs.currentSongIndex || 0;
          state.gameSongs = gs.songs || [];
          state.scores = gs.scores || {};
          state.playerAttempts = gs.playerAttempts || {};
          state.mixed = gs.mixed || false;
          state.mixedSongs = gs.mixedSongs || [];
          state.mode = gs.mode || 'normal';
          state.maxAttempts = gs.maxAttempts || 0;
          state.blurEnabled = gs.blurEnabled || false;
          updatePlayerUI(gs);
        });
        $('playerLobbyStatus').innerHTML = 'Connect√©, attente du d√©but...';
      } catch(e) { alert('Erreur connexion: '+e.message); }
    };

    function initPlayerGame() {
      $('playerBuzzer').disabled = false;
      $('playerFeedback').innerHTML = '';
    }

    function updatePlayerUI(gs) {
      const song = state.gameSongs[state.currentSongIndex];
      $('playerSongInfo').textContent = `Chanson ${state.currentSongIndex+1} / ${state.gameSongs.length}`;
      $('playerScore').textContent = (state.scores[state.clientId] || 0) + ' pts';
      const attemptsData = state.playerAttempts[state.clientId] || { attemptsLeft: state.maxAttempts, cooldownUntil: 0, attemptCount: 0 };
      let attemptsText = '';
      if (state.maxAttempts === 0) attemptsText = '‚àû';
      else attemptsText = attemptsData.attemptsLeft;
      $('playerAttempts').innerHTML = `Essais restants: ${attemptsText}`;

      const now = Date.now();
      if (attemptsData.cooldownUntil && now < attemptsData.cooldownUntil) {
        $('playerBuzzer').disabled = true;
        const wait = Math.ceil((attemptsData.cooldownUntil - now)/1000);
        $('playerFeedback').innerHTML = `‚è≥ Cooldown: ${wait}s`;
      } else if (gs.buzzer === state.clientId) {
        $('playerBuzzer').disabled = true;
        if (state.mixed) {
          if (state.mode === 'kahoot') showChoiceMixPopup();
          else showMixPopup();
        } else {
          if (state.mode === 'kahoot') showChoicePopup();
          else showAnswerPopup();
        }
      } else if (gs.buzzer) {
        $('playerBuzzer').disabled = true;
        $('playerFeedback').innerHTML = '‚è≥ Quelqu\'un a buzz√©...';
      } else {
        if (state.maxAttempts > 0 && attemptsData.attemptsLeft <= 0) {
          $('playerBuzzer').disabled = true;
          $('playerFeedback').innerHTML = '‚ùå Plus d\'essais';
        } else {
          $('playerBuzzer').disabled = false;
          $('playerFeedback').innerHTML = '';
        }
      }
    }

    // === Bouton Je sais ===
    $('playerBuzzer').onclick = async () => {
      if ($('playerBuzzer').disabled) return;
      const now = Date.now();
      const attemptsData = state.playerAttempts[state.clientId] || { attemptsLeft: state.maxAttempts, cooldownUntil: 0, attemptCount: 0 };
      if (state.maxAttempts > 0 && attemptsData.attemptsLeft <= 0) {
        $('playerFeedback').innerHTML = '‚ùå Plus d\'essais';
        return;
      }
      if (attemptsData.cooldownUntil && now < attemptsData.cooldownUntil) {
        const wait = Math.ceil((attemptsData.cooldownUntil - now)/1000);
        $('playerFeedback').innerHTML = `‚è≥ Cooldown: ${wait}s`;
        return;
      }
      $('playerBuzzer').disabled = true;
      const roomRef = db.ref('rooms/' + state.roomCode);
      await roomRef.child('gameState/buzzer').set(state.clientId);
    };

    // === R√©ponse √©crite simple ===
    let answerTimer = null;
    function showAnswerPopup() {
      $('popupAnswer').classList.remove('hidden');
      $('answerInput').value = '';
      $('answerInput').focus();
      let timeLeft = 10;
      $('timer').textContent = timeLeft;
      if (answerTimer) clearInterval(answerTimer);
      answerTimer = setInterval(() => {
        timeLeft--;
        $('timer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(answerTimer);
          submitAnswer('');
        }
      }, 1000);
    }

    $('submitAnswer').onclick = () => {
      const ans = $('answerInput').value.trim();
      submitAnswer(ans);
    };

    async function submitAnswer(answer) {
      if (answerTimer) clearInterval(answerTimer);
      $('popupAnswer').classList.add('hidden');
      const song = state.gameSongs[state.currentSongIndex];
      const correct = song.title;
      const normAnswer = normalize(answer);
      const normCorrect = normalize(correct);
      const isCorrect = normAnswer === normCorrect || normCorrect.includes(normAnswer) || normAnswer.includes(normCorrect);
      const timeElapsed = 10 - parseInt($('timer').textContent);
      let points = 0;
      if (isCorrect) {
        points = 50;
      } else {
        points = -50;
      }
      await sendResult(points, isCorrect ? 1 : 0, correct, isCorrect);
    }

    // === R√©ponse mix (deux titres) ===
    let mixTimer = null;
    function showMixPopup() {
      $('popupMix').classList.remove('hidden');
      $('mixInput1').value = '';
      $('mixInput2').value = '';
      $('mixInput1').focus();
      let timeLeft = 15;
      $('mixTimer').textContent = timeLeft;
      if (mixTimer) clearInterval(mixTimer);
      mixTimer = setInterval(() => {
        timeLeft--;
        $('mixTimer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(mixTimer);
          submitMix('', '');
        }
      }, 1000);
    }

    $('submitMix').onclick = () => {
      const ans1 = $('mixInput1').value.trim();
      const ans2 = $('mixInput2').value.trim();
      submitMix(ans1, ans2);
    };

    async function submitMix(ans1, ans2) {
      if (mixTimer) clearInterval(mixTimer);
      $('popupMix').classList.add('hidden');
      const song1 = state.mixedSongs[0];
      const song2 = state.mixedSongs[1];
      const norm1 = normalize(song1.title);
      const norm2 = normalize(song2.title);
      const a1 = normalize(ans1);
      const a2 = normalize(ans2);
      const ok1 = a1 === norm1 || norm1.includes(a1) || a1.includes(norm1);
      const ok2 = a2 === norm2 || norm2.includes(a2) || a2.includes(norm2);
      let correctCount = (ok1?1:0) + (ok2?1:0);
      let points = 0;
      if (correctCount === 2) points = 100;
      else if (correctCount === 1) points = 0;
      else points = -50;
      await sendResult(points, correctCount, song1.title + ' & ' + song2.title, correctCount === 2);
    }

    // === Choix multiple (mode Kahoot) ===
    let choiceTimer = null;
    function showChoicePopup() {
      const currentSong = state.gameSongs[state.currentSongIndex];
      let otherSongs = songList.filter(s => s.title !== currentSong.title);
      while (otherSongs.length < 5) {
        otherSongs = otherSongs.concat(songList);
      }
      shuffleArray(otherSongs);
      const choices = [currentSong, ...otherSongs.slice(0, 5)];
      shuffleArray(choices);
      const grid = $('choiceGrid');
      grid.innerHTML = '';
      choices.forEach((song, idx) => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = `${idx+1}. ${song.title}`;
        btn.onclick = () => handleChoice(song, currentSong);
        grid.appendChild(btn);
      });
      $('popupChoice').classList.remove('hidden');
      let timeLeft = 5;
      $('choiceTimer').textContent = timeLeft;
      if (choiceTimer) clearInterval(choiceTimer);
      choiceTimer = setInterval(() => {
        timeLeft--;
        $('choiceTimer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(choiceTimer);
          handleChoice(null, currentSong);
        }
      }, 1000);
    }

    async function handleChoice(selected, correct) {
      if (choiceTimer) clearInterval(choiceTimer);
      $('popupChoice').classList.add('hidden');
      const isCorrect = selected && selected.title === correct.title;
      let points = isCorrect ? 50 : -50;
      await sendResult(points, isCorrect ? 1 : 0, correct.title, isCorrect);
    }

    // === Choix multiple pour mix ===
    let choiceMixTimer = null;
    let selectedIndices = [];
    function showChoiceMixPopup() {
      const mixedSongs = state.mixedSongs;
      let otherSongs = songList.filter(s => s.title !== mixedSongs[0].title && s.title !== mixedSongs[1].title);
      while (otherSongs.length < 4) {
        otherSongs = otherSongs.concat(songList);
      }
      shuffleArray(otherSongs);
      const choices = [...mixedSongs, ...otherSongs.slice(0, 4)];
      shuffleArray(choices);
      const grid = $('choiceMixGrid');
      grid.innerHTML = '';
      selectedIndices = [];
      choices.forEach((song, idx) => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = song.title;
        btn.dataset.index = idx;
        btn.dataset.title = song.title;
        btn.onclick = () => toggleChoice(btn, song, choices);
        grid.appendChild(btn);
      });
      $('popupChoiceMix').classList.remove('hidden');
      let timeLeft = 15;
      $('choiceMixTimer').textContent = timeLeft;
      if (choiceMixTimer) clearInterval(choiceMixTimer);
      choiceMixTimer = setInterval(() => {
        timeLeft--;
        $('choiceMixTimer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(choiceMixTimer);
          submitChoiceMix([], mixedSongs);
        }
      }, 1000);
    }

    function toggleChoice(btn, song, allChoices) {
      const idx = parseInt(btn.dataset.index);
      const pos = selectedIndices.indexOf(idx);
      if (pos === -1) {
        if (selectedIndices.length < 2) {
          selectedIndices.push(idx);
          btn.classList.add('selected');
        }
      } else {
        selectedIndices.splice(pos, 1);
        btn.classList.remove('selected');
      }
      if (selectedIndices.length === 2) {
        const selectedSongs = selectedIndices.map(i => allChoices[i]);
        submitChoiceMix(selectedSongs, state.mixedSongs);
      }
    }

    async function submitChoiceMix(selectedSongs, correctSongs) {
      if (choiceMixTimer) clearInterval(choiceMixTimer);
      $('popupChoiceMix').classList.add('hidden');
      let correctCount = 0;
      if (selectedSongs.length === 2) {
        const titles = selectedSongs.map(s => s.title);
        if (titles.includes(correctSongs[0].title) && titles.includes(correctSongs[1].title)) correctCount = 2;
        else if (titles.includes(correctSongs[0].title) || titles.includes(correctSongs[1].title)) correctCount = 1;
        else correctCount = 0;
      }
      let points = 0;
      if (correctCount === 2) points = 100;
      else if (correctCount === 1) points = 0;
      else points = -50;
      await sendResult(points, correctCount, correctSongs[0].title + ' & ' + correctSongs[1].title, correctCount === 2);
    }

    // Fonction commune pour envoyer le r√©sultat et g√©rer les essais/cooldown
    async function sendResult(points, correctCount, correctTitle, success) {
      const roomRef = db.ref('rooms/' + state.roomCode);
      const scores = state.scores;
      scores[state.clientId] = (scores[state.clientId] || 0) + points;

      let attemptsData = state.playerAttempts[state.clientId] || { attemptsLeft: state.maxAttempts, cooldownUntil: 0, attemptCount: 0 };
      if (state.maxAttempts > 0 && !success) {
        attemptsData.attemptsLeft = Math.max(0, attemptsData.attemptsLeft - 1);
        attemptsData.attemptCount = (attemptsData.attemptCount || 0) + 1;
        const cooldown = getCooldown(attemptsData.attemptCount);
        attemptsData.cooldownUntil = Date.now() + cooldown;
      }
      if (success) {
        attemptsData.attemptsLeft = 0;
        attemptsData.cooldownUntil = 0;
      }
      state.playerAttempts[state.clientId] = attemptsData;

      await roomRef.child('gameState').update({
        scores: scores,
        playerAttempts: state.playerAttempts,
        answerResult: { playerId: state.clientId, correct: correctCount, points, correctTitle, playerName: state.playerName },
        buzzer: null,
        mixed: false,
        mixedSongs: [],
      });
    }

    // === Jeu h√¥te ===
    let blurTimer = null;
    let blurInterval = null;
    function updateHostGame() {
      const song = state.gameSongs[state.currentSongIndex];
      $('hostSongInfo').textContent = `Chanson ${state.currentSongIndex+1} / ${state.gameSongs.length} - ${song.title}`;
      if (song.artwork) {
        $('hostCover').src = song.artwork;
      }
      // R√©initialiser le flou quand on change de chanson
      if (blurInterval) clearInterval(blurInterval);
      $('hostCover').className = 'cover-img blur-none';

      let scoresHtml = '<strong>Scores:</strong><br>';
      state.players.forEach(p => {
        scoresHtml += `<div>${p.name}: ${state.scores[p.id] || 0} pts</div>`;
      });
      $('hostScoreboard').innerHTML = scoresHtml;
      $('hostNotification').innerHTML = state.buzzerLocked ? 'üîî Buzz en cours...' : '';
      $('hostNext').disabled = state.buzzerLocked;

      // D√©clencher le mixage √† la chanson 3 (index 2) si pas d√©j√† mix√©
      if (state.currentSongIndex === 2 && !state.mixed && !state.buzzerLocked) {
        let otherIndex;
        do {
          otherIndex = Math.floor(Math.random() * state.gameSongs.length);
        } while (otherIndex === state.currentSongIndex);
        const mixed = [state.gameSongs[state.currentSongIndex], state.gameSongs[otherIndex]];
        const roomRef = db.ref('rooms/' + state.roomCode);
        roomRef.child('gameState').update({ mixed: true, mixedSongs: mixed });
      }

      // √âcouter les r√©sultats
      const answerResultRef = db.ref('rooms/' + state.roomCode + '/gameState/answerResult');
      answerResultRef.on('value', (snap) => {
        const res = snap.val();
        if (res) {
          const player = state.players.find(p => p.id === res.playerId);
          if (player) {
            let msg = `${player.name}: `;
            if (res.correct === 2) msg += `‚úÖ 2 bonnes ! +${res.points}`;
            else if (res.correct === 1) msg += `üü∞ 1 bonne (0 pt)`;
            else msg += `‚ùå 0 bonne (${res.points})`;
            $('hostNotification').innerHTML = msg;
            setTimeout(() => $('hostNotification').innerHTML = '', 3000);
          }
          answerResultRef.remove();
        }
      });
    }

    $('hostPlay').onclick = () => {
      const song = state.gameSongs[state.currentSongIndex];
      if (song.preview) {
        new Audio(song.preview).play().catch(() => alert('Impossible de lire (CORS)'));
        // Gestion du flou progressif si activ√©
        if (state.blurEnabled) {
          // Commencer apr√®s 5 secondes
          if (blurInterval) clearInterval(blurInterval);
          setTimeout(() => {
            let level = 5;
            $('hostCover').className = 'cover-img blur-very-high';
            blurInterval = setInterval(() => {
              level--;
              if (level === 4) $('hostCover').className = 'cover-img blur-high';
              else if (level === 3) $('hostCover').className = 'cover-img blur-medium';
              else if (level === 2) $('hostCover').className = 'cover-img blur-low';
              else if (level === 1) $('hostCover').className = 'cover-img blur-none';
              if (level <= 0) clearInterval(blurInterval);
            }, 1000);
          }, 5000);
        }
      } else alert('Pas d\'extrait');
    };

    $('hostNext').onclick = async () => {
      if (state.currentSongIndex + 1 < state.gameSongs.length) {
        const next = state.currentSongIndex + 1;
        const roomRef = db.ref('rooms/' + state.roomCode);
        // R√©initialiser les tentatives pour le nouveau round
        await roomRef.child('gameState').update({
          currentSongIndex: next,
          buzzer: null,
          mixed: false,
          mixedSongs: [],
          playerAttempts: {}, // remet √† z√©ro les essais pour tous les joueurs
        });
      } else {
        alert('Fin du jeu');
      }
    };

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // Nettoyage
    window.onunload = () => {
      if (state.roomCode) {
        db.ref('rooms/' + state.roomCode).remove();
      }
    };
  })();
</script>
</body>
</html>